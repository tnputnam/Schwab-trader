{% extends "base.html" %}

{% block title %}Market Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .tab-navigation {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }

    .tab-button {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.3s ease;
    }

    .tab-button.active {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .market-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .overview-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .overview-card h3 {
        margin: 0 0 10px 0;
        color: #495057;
        font-size: 1.1rem;
    }

    .overview-card .value {
        font-size: 1.5rem;
        font-weight: 600;
        color: #212529;
    }

    .overview-card .change {
        font-size: 0.9rem;
        margin-top: 5px;
    }

    .overview-card .change.positive {
        color: #198754;
    }

    .overview-card .change.negative {
        color: #dc3545;
    }

    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chart-container h3 {
        margin: 0 0 20px 0;
        color: #495057;
    }

    .chart {
        height: 400px;
    }

    .sector-performance {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .sector-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .sector-card h4 {
        margin: 0 0 10px 0;
        color: #495057;
    }

    .sector-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .sector-metric {
        display: flex;
        flex-direction: column;
    }

    .sector-metric .label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .sector-metric .value {
        font-weight: 500;
        color: #212529;
    }

    .news-feed {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .news-feed h3 {
        margin: 0 0 20px 0;
        color: #495057;
    }

    .news-item {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        transition: background-color 0.2s ease;
    }

    .news-item:hover {
        background-color: #f8f9fa;
    }

    .news-title {
        font-weight: 500;
        margin-bottom: 5px;
        color: #212529;
    }

    .news-summary {
        color: #6c757d;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }

    .news-meta {
        display: flex;
        gap: 15px;
        font-size: 0.8rem;
        color: #6c757d;
    }

    .news-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #dee2e6;
    }

    #page-info {
        color: #6c757d;
    }

    .api-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .api-status.connected {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .api-status.error {
        background-color: #f8d7da;
        color: #842029;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }

    .error-message {
        color: #dc3545;
        padding: 10px;
        background-color: #f8d7da;
        border-radius: 4px;
        margin: 10px 0;
    }

    .news-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .news-filters {
        display: flex;
        gap: 10px;
    }

    .news-filters select {
        min-width: 150px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="tab-navigation">
        <button class="tab-button active" data-tab="overview">Market Overview</button>
        <button class="tab-button" data-tab="sectors">Sector Analysis</button>
        <button class="tab-button" data-tab="news">Market News</button>
    </div>

    <div id="overview" class="tab-content active">
        <div class="market-overview">
            <div class="overview-card">
                <h3>S&P 500</h3>
                <div class="value" id="sp500-value">-</div>
                <div class="change" id="sp500-change">-</div>
            </div>
            <div class="overview-card">
                <h3>NASDAQ</h3>
                <div class="value" id="nasdaq-value">-</div>
                <div class="change" id="nasdaq-change">-</div>
            </div>
            <div class="overview-card">
                <h3>Dow Jones</h3>
                <div class="value" id="dow-value">-</div>
                <div class="change" id="dow-change">-</div>
            </div>
            <div class="overview-card">
                <h3>VIX</h3>
                <div class="value" id="vix-value">-</div>
                <div class="change" id="vix-change">-</div>
            </div>
        </div>

        <div class="chart-container">
            <h3>Market Performance</h3>
            <div class="chart">
                <canvas id="market-chart"></canvas>
            </div>
        </div>
    </div>

    <div id="sectors" class="tab-content">
        <div class="sector-performance" id="sector-grid">
            <!-- Sector cards will be loaded here -->
        </div>
    </div>

    <div id="news" class="tab-content">
        <div class="news-feed">
            <div class="news-header">
                <h3>Latest Market News</h3>
                <div class="news-filters">
                    <select id="news-source" class="form-control">
                        <option value="all">All Sources</option>
                        <option value="reuters">Reuters</option>
                        <option value="bloomberg">Bloomberg</option>
                        <option value="cnbc">CNBC</option>
                        <option value="wsj">Wall Street Journal</option>
                    </select>
                    <select id="news-category" class="form-control">
                        <option value="all">All Categories</option>
                        <option value="market">Market News</option>
                        <option value="economy">Economy</option>
                        <option value="stocks">Stocks</option>
                        <option value="crypto">Cryptocurrency</option>
                    </select>
                    <button id="refresh-news" class="btn btn-primary">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
            <div id="news-container">
                <!-- News items will be loaded here -->
            </div>
            <div class="news-pagination">
                <button id="prev-page" class="btn btn-outline-primary">
                    <i class="bi bi-chevron-left"></i> Previous
                </button>
                <span id="page-info">Page 1 of 1</span>
                <button id="next-page" class="btn btn-outline-primary">
                    Next <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="apiStatus" class="api-status">
    <i class="bi bi-circle-fill"></i> Checking API...
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let marketChart;

    // API Status
    function checkAPIStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('apiStatus');
                if (data.status === 'connected') {
                    statusElement.className = 'api-status connected';
                    statusElement.innerHTML = '<i class="bi bi-check-circle-fill"></i> API Connected';
                } else {
                    statusElement.className = 'api-status error';
                    statusElement.innerHTML = '<i class="bi bi-x-circle-fill"></i> API Error: ' + data.message;
                }
            })
            .catch(error => {
                document.getElementById('apiStatus').className = 'api-status error';
                document.getElementById('apiStatus').innerHTML = '<i class="bi bi-x-circle-fill"></i> API Error';
            });
    }

    // Tab Navigation
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons and contents
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked button and corresponding content
            button.classList.add('active');
            document.getElementById(button.dataset.tab).classList.add('active');
            
            // Load data for the selected tab
            if (button.dataset.tab === 'overview') {
                loadMarketOverview();
            } else if (button.dataset.tab === 'sectors') {
                loadSectorAnalysis();
            } else {
                loadMarketNews();
            }
        });
    });

    // Market Overview Functions
    function loadMarketOverview() {
        fetch('/api/market/overview')
            .then(response => response.json())
            .then(data => {
                updateMarketIndices(data.indices);
                updateMarketChart(data.chart_data);
            })
            .catch(error => {
                console.error('Error loading market overview:', error);
                document.getElementById('overview').innerHTML = '<div class="error-message">Error loading market data. Please try again.</div>';
            });
    }

    function updateMarketIndices(indices) {
        indices.forEach(index => {
            document.getElementById(`${index.symbol.toLowerCase()}-value`).textContent = 
                `$${index.price.toFixed(2)}`;
            document.getElementById(`${index.symbol.toLowerCase()}-change`).textContent = 
                `${index.change >= 0 ? '+' : ''}${index.change.toFixed(2)}%`;
            document.getElementById(`${index.symbol.toLowerCase()}-change`).className = 
                `change ${index.change >= 0 ? 'positive' : 'negative'}`;
        });
    }

    function updateMarketChart(data) {
        const ctx = document.getElementById('market-chart').getContext('2d');
        
        if (marketChart) {
            marketChart.destroy();
        }
        
        marketChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'S&P 500',
                    data: data.sp500,
                    borderColor: '#0d6efd',
                    tension: 0.1
                }, {
                    label: 'NASDAQ',
                    data: data.nasdaq,
                    borderColor: '#198754',
                    tension: 0.1
                }, {
                    label: 'Dow Jones',
                    data: data.dow,
                    borderColor: '#dc3545',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }

    // Sector Analysis Functions
    function loadSectorAnalysis() {
        fetch('/api/market/sectors')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('sector-grid');
                container.innerHTML = '';
                
                data.sectors.forEach(sector => {
                    const card = createSectorCard(sector);
                    container.appendChild(card);
                });
            })
            .catch(error => {
                console.error('Error loading sector analysis:', error);
                document.getElementById('sectors').innerHTML = '<div class="error-message">Error loading sector data. Please try again.</div>';
            });
    }

    function createSectorCard(sector) {
        const card = document.createElement('div');
        card.className = 'sector-card';
        
        card.innerHTML = `
            <h4>${sector.name}</h4>
            <div class="sector-metrics">
                <div class="sector-metric">
                    <span class="label">Performance</span>
                    <span class="value ${sector.performance >= 0 ? 'positive' : 'negative'}">
                        ${sector.performance >= 0 ? '+' : ''}${sector.performance.toFixed(2)}%
                    </span>
                </div>
                <div class="sector-metric">
                    <span class="label">Volume</span>
                    <span class="value">${formatNumber(sector.volume)}</span>
                </div>
                <div class="sector-metric">
                    <span class="label">Market Cap</span>
                    <span class="value">$${formatNumber(sector.market_cap)}</span>
                </div>
                <div class="sector-metric">
                    <span class="label">Stocks</span>
                    <span class="value">${sector.stock_count}</span>
                </div>
            </div>
        `;
        
        return card;
    }

    // Enhanced Market News Functions
    let currentPage = 1;
    let totalPages = 1;
    let currentSource = 'all';
    let currentCategory = 'all';

    function loadMarketNews() {
        const container = document.getElementById('news-container');
        container.innerHTML = '<div class="loading">Loading news...</div>';

        fetch(`/api/market/news?page=${currentPage}&source=${currentSource}&category=${currentCategory}`)
            .then(response => response.json())
            .then(data => {
                container.innerHTML = '';
                totalPages = data.total_pages;
                
                updatePagination();
                
                data.news.forEach(item => {
                    const newsItem = createNewsItem(item);
                    container.appendChild(newsItem);
                });
            })
            .catch(error => {
                console.error('Error loading market news:', error);
                container.innerHTML = '<div class="error-message">Error loading news. Please try again.</div>';
            });
    }

    function createNewsItem(item) {
        const newsItem = document.createElement('div');
        newsItem.className = 'news-item';
        
        newsItem.innerHTML = `
            <div class="news-title">${item.title}</div>
            <div class="news-summary">${item.summary}</div>
            <div class="news-meta">
                <span>${item.source}</span>
                <span>${new Date(item.published_at).toLocaleString()}</span>
                <span>${item.category}</span>
            </div>
        `;
        
        newsItem.addEventListener('click', () => {
            window.open(item.url, '_blank');
        });
        
        return newsItem;
    }

    function updatePagination() {
        document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages;
    }

    // Event Listeners for News
    document.getElementById('news-source').addEventListener('change', (e) => {
        currentSource = e.target.value;
        currentPage = 1;
        loadMarketNews();
    });

    document.getElementById('news-category').addEventListener('change', (e) => {
        currentCategory = e.target.value;
        currentPage = 1;
        loadMarketNews();
    });

    document.getElementById('refresh-news').addEventListener('click', loadMarketNews);
    document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            loadMarketNews();
        }
    });
    document.getElementById('next-page').addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            loadMarketNews();
        }
    });

    // Helper Functions
    function formatNumber(num) {
        if (num >= 1000000000) {
            return (num / 1000000000).toFixed(1) + 'B';
        }
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        }
        if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
    }

    // Initial Load
    checkAPIStatus();
    loadMarketOverview();
</script>
{% endblock %} 