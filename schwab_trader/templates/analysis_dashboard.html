{% extends "base.html" %}
{% import "components.html" as components %}

{% block title %}Market Analysis Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .control-panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .stock-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .stock-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stock-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .stock-title {
        font-size: 1.2rem;
        font-weight: 500;
        color: #1a237e;
    }

    .stock-signal {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .signal-buy {
        background-color: #d4edda;
        color: #155724;
    }

    .signal-sell {
        background-color: #f8d7da;
        color: #721c24;
    }

    .signal-hold {
        background-color: #fff3cd;
        color: #856404;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .metric-card {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
    }

    .metric-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .metric-value {
        font-size: 1.1rem;
        font-weight: 500;
    }

    .chart-container {
        height: 300px;
        margin-top: 20px;
    }

    .alerts-section {
        margin-top: 20px;
    }

    .alert-card {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .alert-time {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .alert-message {
        font-size: 0.9rem;
        color: #856404;
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }

    .comparison-section {
        margin-top: 30px;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .comparison-chart {
        height: 400px;
        margin-top: 20px;
    }

    .stream-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .data-stream {
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
    }

    .data-point {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
    }

    .data-point:last-child {
        border-bottom: none;
    }

    .data-label {
        font-weight: 500;
        color: #6c757d;
    }

    .data-value {
        color: #212529;
    }

    .stream-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .stream-button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }

    .start-stream {
        background: #198754;
        color: white;
    }

    .stop-stream {
        background: #dc3545;
        color: white;
    }

    .clear-stream {
        background: #6c757d;
        color: white;
    }

    .technical-indicators {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }

    .indicator-card {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        border-left: 4px solid #6c757d;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .indicator-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .indicator-card.positive {
        border-left-color: #198754;
    }

    .indicator-card.negative {
        border-left-color: #dc3545;
    }

    .indicator-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .service-status {
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 4px;
        background-color: #f8f9fa;
        border-left: 4px solid #6c757d;
    }

    .service-status.warning {
        background-color: #fff3cd;
        border-left-color: #ffc107;
    }

    .service-status.error {
        background-color: #f8d7da;
        border-left-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    {% if not services_available %}
    <div class="service-status warning">
        <h4><i class="bi bi-exclamation-triangle"></i> Service Status</h4>
        <p>Some market analysis services are currently unavailable. Basic functionality may be limited.</p>
        <p>Please check the logs for more information or try refreshing the page.</p>
    </div>
    {% endif %}

    <div class="control-panel">
        <h2>Market Analysis Dashboard</h2>
        <div class="control-grid">
            <div class="form-group">
                <label for="symbol">Symbol</label>
                <input type="text" id="symbol" class="form-control" placeholder="e.g., AAPL">
            </div>
            <div class="form-group">
                <label for="timeframe">Timeframe</label>
                <select id="timeframe" class="form-control">
                    <option value="1d">1 Day</option>
                    <option value="1w">1 Week</option>
                    <option value="1m">1 Month</option>
                    <option value="3m">3 Months</option>
                    <option value="1y">1 Year</option>
                </select>
            </div>
            <div class="form-group">
                <label for="dataType">Data Type</label>
                <select id="dataType" class="form-control">
                    <option value="price">Price</option>
                    <option value="technical">Technical</option>
                </select>
            </div>
        </div>
        <button id="loadData" class="btn btn-primary">Load Data</button>
    </div>

    <div class="stock-grid">
        {% if services_available %}
        <div class="stock-card">
            <div class="stock-header">
                <h3 class="stock-title">Market Status</h3>
                <span id="marketStatus" class="stock-signal">Loading...</span>
            </div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Last Update</div>
                    <div id="lastUpdate" class="metric-value">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Market State</div>
                    <div id="marketState" class="metric-value">-</div>
                </div>
            </div>
        </div>

        <div class="stock-card">
            <div class="stock-header">
                <h3 class="stock-title">Technical Analysis</h3>
            </div>
            <div class="technical-indicators">
                <div class="indicator-card">
                    <div class="indicator-label">RSI (14)</div>
                    <div id="rsiValue" class="metric-value">-</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-label">SMA (20)</div>
                    <div id="sma20Value" class="metric-value">-</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-label">SMA (50)</div>
                    <div id="sma50Value" class="metric-value">-</div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="stock-card">
            <h3>Service Unavailable</h3>
            <p>Stock analysis features are currently unavailable. Please try again later.</p>
        </div>
        {% endif %}
    </div>

    <div class="chart-container">
        <canvas id="priceChart"></canvas>
    </div>

    <div class="alerts-section">
        <h3>Market Alerts</h3>
        <div id="alertsContainer"></div>
    </div>

    <div class="stream-section">
        <h3>Real-time Data Stream</h3>
        <div class="stream-controls">
            <button id="startStream" class="stream-button start-stream">Start Stream</button>
            <button id="stopStream" class="stream-button stop-stream">Stop Stream</button>
            <button id="clearStream" class="stream-button clear-stream">Clear</button>
        </div>
        <div class="data-stream" id="dataStream"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let priceChart = null;
    let dataStream = null;

    // Initialize market status
    function updateMarketStatus() {
        fetch('/analysis/dashboard/api/market-status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('marketStatus').textContent = data.data.state;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                    document.getElementById('marketState').textContent = data.data.state;
                }
            })
            .catch(error => console.error('Error fetching market status:', error));
    }

    // Load market data
    function loadMarketData() {
        const symbol = document.getElementById('symbol').value || 'AAPL';
        const timeframe = document.getElementById('timeframe').value;
        const dataType = document.getElementById('dataType').value;

        fetch(`/analysis/dashboard/api/market-data?symbol=${symbol}&timeframe=${timeframe}&type=${dataType}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateChart(data.data);
                    updateTechnicalIndicators(data.data);
                }
            })
            .catch(error => console.error('Error fetching market data:', error));
    }

    // Update chart
    function updateChart(data) {
        const ctx = document.getElementById('priceChart').getContext('2d');
        
        if (priceChart) {
            priceChart.destroy();
        }

        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'Price',
                    data: data.prices,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Update technical indicators
    function updateTechnicalIndicators(data) {
        if (data.rsi) {
            document.getElementById('rsiValue').textContent = data.rsi[data.rsi.length - 1].toFixed(2);
        }
        if (data.sma_20) {
            document.getElementById('sma20Value').textContent = data.sma_20[data.sma_20.length - 1].toFixed(2);
        }
        if (data.sma_50) {
            document.getElementById('sma50Value').textContent = data.sma_50[data.sma_50.length - 1].toFixed(2);
        }
    }

    // Initialize data stream
    function startDataStream() {
        if (dataStream) {
            dataStream.close();
        }

        dataStream = new EventSource('/analysis/dashboard/stream-data');
        dataStream.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const streamContainer = document.getElementById('dataStream');
            const dataPoint = document.createElement('div');
            dataPoint.className = 'data-point';
            dataPoint.innerHTML = `
                <div class="data-label">Time</div>
                <div class="data-value">${new Date(data.timestamp).toLocaleTimeString()}</div>
                <div class="data-label">Symbol</div>
                <div class="data-value">${data.symbol}</div>
                <div class="data-label">Price</div>
                <div class="data-value">${data.price}</div>
            `;
            streamContainer.insertBefore(dataPoint, streamContainer.firstChild);
        };
    }

    // Event listeners
    document.getElementById('loadData').addEventListener('click', loadMarketData);
    document.getElementById('startStream').addEventListener('click', startDataStream);
    document.getElementById('stopStream').addEventListener('click', () => {
        if (dataStream) {
            dataStream.close();
            dataStream = null;
        }
    });
    document.getElementById('clearStream').addEventListener('click', () => {
        document.getElementById('dataStream').innerHTML = '';
    });

    // Initial load
    updateMarketStatus();
    setInterval(updateMarketStatus, 60000); // Update every minute
</script>
{% endblock %} 