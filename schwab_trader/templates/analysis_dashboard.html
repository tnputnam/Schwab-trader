{% extends "base.html" %}

{% block title %}Analysis Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .tab-navigation {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }

    .tab-button {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.3s ease;
    }

    .tab-button.active {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-weight: 500;
        color: #495057;
    }

    .stock-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .stock-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 15px;
        transition: transform 0.2s ease;
    }

    .stock-card:hover {
        transform: translateY(-2px);
    }

    .stock-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .stock-symbol {
        font-size: 1.2rem;
        font-weight: 600;
        color: #212529;
    }

    .stock-price {
        font-size: 1.1rem;
        font-weight: 500;
    }

    .stock-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin: 10px 0;
    }

    .metric {
        display: flex;
        flex-direction: column;
    }

    .metric-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .metric-value {
        font-weight: 500;
        color: #212529;
    }

    .stock-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .action-button {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.2s ease;
    }

    .action-button.watchlist {
        background-color: #e9ecef;
        color: #495057;
    }

    .action-button.alert {
        background-color: #fff3cd;
        color: #856404;
    }

    .action-button.details {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .volume-chart {
        height: 300px;
        margin-top: 20px;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }

    .error-message {
        color: #dc3545;
        padding: 10px;
        background-color: #f8d7da;
        border-radius: 4px;
        margin: 10px 0;
    }

    .api-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .api-status.connected {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .api-status.error {
        background-color: #f8d7da;
        color: #842029;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="tab-navigation">
        <button class="tab-button active" data-tab="volatile">Volatile Stocks</button>
        <button class="tab-button" data-tab="volume">Volume Analysis</button>
    </div>

    <div id="volatile" class="tab-content active">
        <div class="filter-section">
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="minVolatility">Minimum Volatility (%)</label>
                    <input type="number" id="minVolatility" class="form-control" value="2" min="0" step="0.1">
                </div>
                <div class="filter-group">
                    <label for="minVolume">Minimum Volume</label>
                    <input type="number" id="minVolume" class="form-control" value="1000000">
                </div>
                <div class="filter-group">
                    <label for="marketCap">Market Cap Range</label>
                    <select id="marketCap" class="form-control">
                        <option value="all">All</option>
                        <option value="large">Large Cap (>$10B)</option>
                        <option value="mid">Mid Cap ($2B-$10B)</option>
                        <option value="small">Small Cap (<$2B)</option>
                    </select>
                </div>
            </div>
            <button id="refreshVolatile" class="btn btn-primary mt-3">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>

        <div id="volatileStocks" class="stock-grid">
            <!-- Volatile stocks will be loaded here -->
        </div>
    </div>

    <div id="volume" class="tab-content">
        <div class="filter-section">
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="volumeThreshold">Volume Threshold</label>
                    <input type="number" id="volumeThreshold" class="form-control" value="2000000">
                </div>
                <div class="filter-group">
                    <label for="priceChange">Price Change (%)</label>
                    <input type="number" id="priceChange" class="form-control" value="2" min="0" step="0.1">
                </div>
                <div class="filter-group">
                    <label for="timeframe">Timeframe</label>
                    <select id="timeframe" class="form-control">
                        <option value="1d">1 Day</option>
                        <option value="5d">5 Days</option>
                        <option value="1m">1 Month</option>
                    </select>
                </div>
            </div>
            <button id="refreshVolume" class="btn btn-primary mt-3">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>

        <div id="volumeAnalysis" class="stock-grid">
            <!-- Volume analysis will be loaded here -->
        </div>
    </div>
</div>

<div id="apiStatus" class="api-status">
    <i class="bi bi-circle-fill"></i> Checking API...
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // API Status
    function checkAPIStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('apiStatus');
                if (data.status === 'connected') {
                    statusElement.className = 'api-status connected';
                    statusElement.innerHTML = '<i class="bi bi-check-circle-fill"></i> API Connected';
                } else {
                    statusElement.className = 'api-status error';
                    statusElement.innerHTML = '<i class="bi bi-x-circle-fill"></i> API Error: ' + data.message;
                }
            })
            .catch(error => {
                document.getElementById('apiStatus').className = 'api-status error';
                document.getElementById('apiStatus').innerHTML = '<i class="bi bi-x-circle-fill"></i> API Error';
            });
    }

    // Tab Navigation
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons and contents
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked button and corresponding content
            button.classList.add('active');
            document.getElementById(button.dataset.tab).classList.add('active');
            
            // Load data for the selected tab
            if (button.dataset.tab === 'volatile') {
                loadVolatileStocks();
            } else {
                loadVolumeAnalysis();
            }
        });
    });

    // Volatile Stocks Functions
    function loadVolatileStocks() {
        const minVolatility = document.getElementById('minVolatility').value;
        const minVolume = document.getElementById('minVolume').value;
        const marketCap = document.getElementById('marketCap').value;

        fetch(`/api/volatile_stocks?min_volatility=${minVolatility}&min_volume=${minVolume}&market_cap=${marketCap}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('volatileStocks');
                container.innerHTML = '';
                
                data.stocks.forEach(stock => {
                    const card = createStockCard(stock);
                    container.appendChild(card);
                });
            })
            .catch(error => {
                console.error('Error loading volatile stocks:', error);
                document.getElementById('volatileStocks').innerHTML = '<div class="error-message">Error loading stocks. Please try again.</div>';
            });
    }

    // Volume Analysis Functions
    function loadVolumeAnalysis() {
        const threshold = document.getElementById('volumeThreshold').value;
        const priceChange = document.getElementById('priceChange').value;
        const timeframe = document.getElementById('timeframe').value;

        fetch(`/api/volume_analysis?threshold=${threshold}&price_change=${priceChange}&timeframe=${timeframe}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('volumeAnalysis');
                container.innerHTML = '';
                
                data.stocks.forEach(stock => {
                    const card = createStockCard(stock);
                    container.appendChild(card);
                });
            })
            .catch(error => {
                console.error('Error loading volume analysis:', error);
                document.getElementById('volumeAnalysis').innerHTML = '<div class="error-message">Error loading analysis. Please try again.</div>';
            });
    }

    // Helper Functions
    function createStockCard(stock) {
        const card = document.createElement('div');
        card.className = 'stock-card';
        
        card.innerHTML = `
            <div class="stock-header">
                <span class="stock-symbol">${stock.symbol}</span>
                <span class="stock-price">$${stock.price.toFixed(2)}</span>
            </div>
            <div class="stock-metrics">
                <div class="metric">
                    <span class="metric-label">Volume</span>
                    <span class="metric-value">${formatNumber(stock.volume)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Change</span>
                    <span class="metric-value ${stock.change >= 0 ? 'text-success' : 'text-danger'}">
                        ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}%
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Volatility</span>
                    <span class="metric-value">${stock.volatility.toFixed(2)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Market Cap</span>
                    <span class="metric-value">$${formatNumber(stock.market_cap)}</span>
                </div>
            </div>
            <div class="stock-actions">
                <button class="action-button watchlist" onclick="addToWatchlist('${stock.symbol}')">
                    <i class="bi bi-plus-circle"></i> Watchlist
                </button>
                <button class="action-button alert" onclick="setAlert('${stock.symbol}')">
                    <i class="bi bi-bell"></i> Alert
                </button>
                <button class="action-button details" onclick="viewDetails('${stock.symbol}')">
                    <i class="bi bi-info-circle"></i> Details
                </button>
            </div>
        `;
        
        return card;
    }

    function formatNumber(num) {
        if (num >= 1000000000) {
            return (num / 1000000000).toFixed(1) + 'B';
        }
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        }
        if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
    }

    // Event Listeners
    document.getElementById('refreshVolatile').addEventListener('click', loadVolatileStocks);
    document.getElementById('refreshVolume').addEventListener('click', loadVolumeAnalysis);

    // Initial Load
    checkAPIStatus();
    loadVolatileStocks();
</script>
{% endblock %} 