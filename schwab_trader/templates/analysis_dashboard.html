{% extends "base.html" %}
{% import "components.html" as components %}

{% block title %}Analysis Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .tab-navigation {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }

    .tab-button {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.3s ease;
    }

    .tab-button.active {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-weight: 500;
        color: #495057;
    }

    .stock-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .stock-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 15px;
        transition: transform 0.2s ease;
    }

    .stock-card:hover {
        transform: translateY(-2px);
    }

    .stock-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .stock-symbol {
        font-size: 1.2rem;
        font-weight: 600;
        color: #212529;
    }

    .stock-price {
        font-size: 1.1rem;
        font-weight: 500;
    }

    .stock-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin: 10px 0;
    }

    .metric {
        display: flex;
        flex-direction: column;
    }

    .metric-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .metric-value {
        font-weight: 500;
        color: #212529;
    }

    .stock-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .action-button {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.2s ease;
    }

    .action-button.watchlist {
        background-color: #e9ecef;
        color: #495057;
    }

    .action-button.alert {
        background-color: #fff3cd;
        color: #856404;
    }

    .action-button.details {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .volume-chart {
        height: 300px;
        margin-top: 20px;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }

    .error-message {
        color: #dc3545;
        padding: 10px;
        background-color: #f8d7da;
        border-radius: 4px;
        margin: 10px 0;
    }

    .api-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .api-status.connected {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .api-status.error {
        background-color: #f8d7da;
        color: #842029;
    }

    .simulation-results {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 15px;
        margin-top: 20px;
    }

    .simulation-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .simulation-metric {
        text-align: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .simulation-metric .label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .simulation-metric .value {
        font-size: 1.2rem;
        font-weight: 600;
        color: #212529;
    }

    .simulation-metric .value.positive {
        color: #198754;
    }

    .simulation-metric .value.negative {
        color: #dc3545;
    }

    .trade-history {
        margin-top: 20px;
    }

    .trade-history table {
        width: 100%;
        border-collapse: collapse;
    }

    .trade-history th,
    .trade-history td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }

    .trade-history th {
        background: #f8f9fa;
        font-weight: 500;
    }

    .trade-history tr:hover {
        background: #f8f9fa;
    }

    .trade-history .profit.positive {
        color: #198754;
    }

    .trade-history .profit.negative {
        color: #dc3545;
    }

    .milestones-section {
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 15px;
    }

    .milestones-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .milestone-item {
        padding: 10px;
        border-radius: 4px;
        border-left: 4px solid;
    }

    .milestone-item.positive {
        background: #d1e7dd;
        border-left-color: #198754;
    }

    .milestone-item.negative {
        background: #f8d7da;
        border-left-color: #dc3545;
    }

    .milestone-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }

    .milestone-date {
        font-weight: 500;
    }

    .milestone-type {
        text-transform: capitalize;
        font-weight: 600;
    }

    .milestone-amount {
        font-weight: 600;
    }

    .milestone-details {
        font-size: 0.9rem;
        color: #495057;
    }

    .milestone-cause {
        margin-bottom: 5px;
    }

    .milestone-total {
        font-weight: 500;
    }

    .performance-graph {
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 15px;
    }

    .graph-container {
        height: 400px;
        position: relative;
    }

    .performance-graph h4 {
        color: #1a237e;
        margin-bottom: 15px;
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    {% if not alpha_vantage_available %}
    <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">Alpha Vantage API Not Configured</h4>
        <p>To use the technical analysis features, please set the ALPHA_VANTAGE_API_KEY environment variable.</p>
        <hr>
        <p class="mb-0">You can still view the dashboard, but real-time data and analysis features will be limited.</p>
    </div>
    {% else %}
    <div class="tab-navigation">
        <button class="tab-button {% if active_tab == 'volume' %}active{% endif %}" 
                onclick="showTab('volume')">Volume Analysis</button>
        <button class="tab-button {% if active_tab == 'technical' %}active{% endif %}" 
                onclick="showTab('technical')">Technical Analysis</button>
        <button class="tab-button {% if active_tab == 'fundamental' %}active{% endif %}" 
                onclick="showTab('fundamental')">Fundamental Analysis</button>
    </div>

    <div id="volume-tab" class="tab-content {% if active_tab == 'volume' %}active{% endif %}">
        <div class="filter-section">
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="timeframe">Timeframe</label>
                    <select id="timeframe" class="form-select">
                        <option value="1m">1 Month</option>
                        <option value="3m">3 Months</option>
                        <option value="6m">6 Months</option>
                        <option value="1y" selected>1 Year</option>
                        <option value="2y">2 Years</option>
                        <option value="5y">5 Years</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="volume-type">Volume Type</label>
                    <select id="volume-type" class="form-select">
                        <option value="raw">Raw Volume</option>
                        <option value="relative">Relative Volume</option>
                        <option value="sma">Volume SMA</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="stock-grid">
            {% for symbol, data in stock_data.items() %}
            <div class="stock-card">
                <div class="stock-header">
                    <span class="stock-symbol">{{ symbol }}</span>
                    <span class="stock-price">
                        {% if data and data|length > 0 %}
                            ${{ data[0].close|round(2) }}
                        {% else %}
                            No data available
                        {% endif %}
                    </span>
                </div>
                
                <div class="stock-metrics">
                    <div class="metric">
                        <span class="metric-label">Average Volume</span>
                        <span class="metric-value">
                            {% if data and data|length > 0 %}
                                {{ (data|sum(attribute='volume') / data|length)|int }}
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Days</span>
                        <span class="metric-value">
                            {% if data %}
                                {{ data|length }}
                            {% else %}
                                0
                            {% endif %}
                        </span>
                    </div>
                </div>

                <div class="volume-chart">
                    {% if data and data|length > 0 %}
                        <canvas id="{{ symbol }}-volume-chart"></canvas>
                    {% else %}
                        <div class="alert alert-warning">No data available for chart</div>
                    {% endif %}
                </div>

                {% if symbol == 'TSLA' %}
                <div class="stock-card">
                    <div class="stock-header">
                        <span class="stock-symbol">{{ symbol }}</span>
                        <span class="stock-price">${{ data[0].close|round(2) }}</span>
                    </div>
                    
                    <div class="stock-metrics">
                        <div class="metric">
                            <span class="metric-label">Average Volume</span>
                            <span class="metric-value">{{ (data|sum(attribute='volume') / data|length)|int }}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Total Days</span>
                            <span class="metric-value">{{ data|length }}</span>
                        </div>
                    </div>

                    <div class="volume-chart">
                        <canvas id="{{ symbol }}-volume-chart"></canvas>
                    </div>

                    {% if simulation_results[symbol] %}
                    <div class="simulation-results">
                        <h4>Volume Trading Simulation</h4>
                        <div class="simulation-metrics">
                            <div class="simulation-metric">
                                <div class="label">Initial Budget</div>
                                <div class="value">${{ simulation_results[symbol].initial_budget|int }}</div>
                            </div>
                            <div class="simulation-metric">
                                <div class="label">Final Budget</div>
                                <div class="value {% if simulation_results[symbol].final_budget > simulation_results[symbol].initial_budget %}positive{% else %}negative{% endif %}">
                                    ${{ simulation_results[symbol].final_budget|int }}
                                </div>
                            </div>
                            <div class="simulation-metric">
                                <div class="label">Total Profit</div>
                                <div class="value {% if simulation_results[symbol].total_profit > 0 %}positive{% else %}negative{% endif %}">
                                    {{ simulation_results[symbol].total_profit|round(2) }}%
                                </div>
                            </div>
                            <div class="simulation-metric">
                                <div class="label">Profit Amount</div>
                                <div class="value {% if simulation_results[symbol].total_profit_amount > 0 %}positive{% else %}negative{% endif %}">
                                    ${{ simulation_results[symbol].total_profit_amount|round(2) }}
                                </div>
                            </div>
                        </div>

                        {% if simulation_results[symbol].milestones %}
                        <div class="milestones-section">
                            <h5>Significant Milestones ($500+)</h5>
                            <div class="milestones-list">
                                {% for milestone in simulation_results[symbol].milestones %}
                                <div class="milestone-item {% if milestone.type == 'gain' %}positive{% else %}negative{% endif %}">
                                    <div class="milestone-header">
                                        <span class="milestone-date">{{ milestone.date }}</span>
                                        <span class="milestone-type">{{ milestone.type|title }}</span>
                                        <span class="milestone-amount">${{ milestone.amount|round(2) }}</span>
                                    </div>
                                    <div class="milestone-details">
                                        <div class="milestone-cause">{{ milestone.cause }}</div>
                                        <div class="milestone-total">New Total: ${{ milestone.total|round(2) }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="trade-history">
                            <h5>Trade History</h5>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Price</th>
                                        <th>Shares</th>
                                        <th>Value</th>
                                        <th>Profit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for trade in simulation_results[symbol].trades %}
                                    <tr>
                                        <td>{{ trade.date }}</td>
                                        <td>{{ trade.type|title }}</td>
                                        <td>${{ trade.price|round(2) }}</td>
                                        <td>{{ trade.shares }}</td>
                                        <td>${{ trade.trade_value|round(2) if trade.type == 'sell' else trade.cost|round(2) }}</td>
                                        <td class="profit {% if trade.type == 'sell' and trade.profit > 0 %}positive{% elif trade.type == 'sell' and trade.profit < 0 %}negative{% endif %}">
                                            {% if trade.type == 'sell' %}
                                            {{ trade.profit|round(2) }}%
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <div class="stock-actions">
                        <button class="action-button details" onclick="showDetails('{{ symbol }}')">
                            View Details
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    {% if 'TSLA' in stock_data and simulation_results['TSLA'] %}
    <div class="performance-graph" style="margin-top: 40px; width: 100%;">
        <h4 style="text-align: center; margin-bottom: 20px;">TSLA Trading Performance</h4>
        <div class="graph-container" style="height: 600px; width: 100%; position: relative; margin: 20px 0; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px;">
            <canvas id="tsla-performance-chart" style="width: 100%; height: 100%;"></canvas>
        </div>
        <!-- Debug information -->
        <div style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
            <p>Data points: {{ stock_data['TSLA']|length }}</p>
            <p>First date: {{ stock_data['TSLA'][0].date if stock_data['TSLA'] else 'No data' }}</p>
            <p>Last date: {{ stock_data['TSLA'][-1].date if stock_data['TSLA'] else 'No data' }}</p>
        </div>
    </div>
    {% endif %}

    <div id="technical-tab" class="tab-content {% if active_tab == 'technical' %}active{% endif %}">
        <!-- Technical analysis content will go here -->
    </div>

    <div id="fundamental-tab" class="tab-content {% if active_tab == 'fundamental' %}active{% endif %}">
        <!-- Fundamental analysis content will go here -->
    </div>
    {% endif %}
</div>

{{ components.api_status() }}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`${tabName}-tab`).classList.add('active');
    document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
}

function showDetails(symbol) {
    // Implement details view
    console.log(`Showing details for ${symbol}`);
}

document.addEventListener('DOMContentLoaded', function() {
    {% for symbol, data in stock_data.items() %}
    // Volume Chart
    const {{ symbol }}VolumeCtx = document.getElementById('{{ symbol }}-volume-chart').getContext('2d');
    const {{ symbol }}VolumeData = {
        labels: {{ data|map(attribute='date')|list|tojson }},
        datasets: [{
            label: 'Volume',
            data: {{ data|map(attribute='volume')|list|tojson }},
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    };
    
    new Chart({{ symbol }}VolumeCtx, {
        type: 'bar',
        data: {{ symbol }}VolumeData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    {% if symbol == 'TSLA' and simulation_results[symbol] %}
    // TSLA Performance Chart
    console.log('Creating TSLA performance chart...');
    const tslaPerformanceCtx = document.getElementById('tsla-performance-chart');
    if (!tslaPerformanceCtx) {
        console.error('Could not find performance chart canvas');
        return;
    }
    
    // Prepare data for the performance chart
    const tslaDates = {{ data|map(attribute='date')|list|tojson }};
    const tslaPrices = {{ data|map(attribute='close')|list|tojson }};
    const tslaVolumes = {{ data|map(attribute='volume')|list|tojson }};
    
    // Sort data in chronological order
    const sortedData = tslaDates.map((date, index) => ({
        date: date,
        price: tslaPrices[index],
        volume: tslaVolumes[index]
    })).sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const sortedDates = sortedData.map(d => d.date);
    const sortedPrices = sortedData.map(d => d.price);
    const sortedVolumes = sortedData.map(d => d.volume);
    
    console.log('Data points:', sortedDates.length);
    console.log('First date:', sortedDates[0]);
    console.log('Last date:', sortedDates[sortedDates.length - 1]);
    
    // Get trade points
    const tslaTrades = {{ simulation_results[symbol].trades|tojson }};
    console.log('Raw trades:', tslaTrades);
    console.log('Number of trades:', tslaTrades.length);
    
    const tslaBuyPoints = tslaTrades.filter(t => t.type === 'buy').map(t => ({
        x: t.date,
        y: t.price
    }));
    console.log('Buy points:', tslaBuyPoints);
    
    const tslaSellPoints = tslaTrades.filter(t => t.type === 'sell').map(t => ({
        x: t.date,
        y: t.price
    }));
    console.log('Sell points:', tslaSellPoints);
    
    // Get milestone points
    const tslaMilestones = {{ simulation_results[symbol].milestones|tojson }};
    console.log('Number of milestones:', tslaMilestones.length);
    
    const tslaMilestonePoints = tslaMilestones.map(m => ({
        x: m.date,
        y: sortedPrices[sortedDates.indexOf(m.date)]
    }));
    
    const tslaPerformanceData = {
        labels: sortedDates,
        datasets: [
            {
                label: 'Price',
                data: sortedPrices,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
                yAxisID: 'y',
                tension: 0.4
            },
            {
                label: 'Volume',
                data: sortedVolumes,
                borderColor: 'rgba(54, 162, 235, 0.5)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                fill: true,
                yAxisID: 'y1',
                tension: 0.4
            },
            {
                label: 'Buy Points',
                data: tslaBuyPoints,
                pointBackgroundColor: '#28a745',
                pointBorderColor: '#fff',
                pointRadius: 10,
                pointHoverRadius: 15,
                pointBorderWidth: 2,
                showLine: false,
                yAxisID: 'y'
            },
            {
                label: 'Sell Points',
                data: tslaSellPoints,
                pointBackgroundColor: '#dc3545',
                pointBorderColor: '#fff',
                pointRadius: 10,
                pointHoverRadius: 15,
                pointBorderWidth: 2,
                showLine: false,
                yAxisID: 'y'
            },
            {
                label: 'Milestones',
                data: tslaMilestonePoints,
                pointBackgroundColor: '#ffc107',
                pointBorderColor: '#fff',
                pointRadius: 12,
                pointHoverRadius: 17,
                pointBorderWidth: 2,
                showLine: false,
                yAxisID: 'y'
            }
        ]
    };
    
    new Chart(tslaPerformanceCtx, {
        type: 'line',
        data: tslaPerformanceData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Price ($)',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Volume',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 12
                        },
                        maxRotation: 45,
                        minRotation: 45,
                        autoSkip: true,
                        maxTicksLimit: 20
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.datasetIndex === 0) {
                                label += '$' + context.parsed.y.toFixed(2);
                            } else if (context.datasetIndex === 1) {
                                label += context.parsed.y.toLocaleString();
                            } else if (context.datasetIndex === 2) {
                                const trade = tslaTrades.find(t => t.date === context.label && t.type === 'buy');
                                if (trade) {
                                    label += `Buy at $${trade.price.toFixed(2)} (${trade.shares} shares)`;
                                }
                            } else if (context.datasetIndex === 3) {
                                const trade = tslaTrades.find(t => t.date === context.label && t.type === 'sell');
                                if (trade) {
                                    label += `Sell at $${trade.price.toFixed(2)} (${trade.shares} shares, Profit: ${trade.profit.toFixed(2)}%)`;
                                }
                            }
                            return label;
                        }
                    }
                },
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 20,
                        font: {
                            size: 14
                        }
                    }
                },
                zoom: {
                    zoom: {
                        wheel: {
                            enabled: true
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'xy'
                    },
                    pan: {
                        enabled: true,
                        mode: 'xy'
                    }
                }
            }
        }
    });
    {% endif %}
    {% endfor %}
});
</script>
{% endblock %} 