{% extends "base.html" %}
{% import "components.html" as components %}

{% block title %}Analysis Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .tab-navigation {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }

    .tab-button {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.3s ease;
    }

    .tab-button.active {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-weight: 500;
        color: #495057;
    }

    .stock-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .stock-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 15px;
        transition: transform 0.2s ease;
    }

    .stock-card:hover {
        transform: translateY(-2px);
    }

    .stock-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .stock-symbol {
        font-size: 1.2rem;
        font-weight: 600;
        color: #212529;
    }

    .stock-price {
        font-size: 1.1rem;
        font-weight: 500;
    }

    .stock-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin: 10px 0;
    }

    .metric {
        display: flex;
        flex-direction: column;
    }

    .metric-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .metric-value {
        font-weight: 500;
        color: #212529;
    }

    .stock-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .action-button {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.2s ease;
    }

    .action-button.watchlist {
        background-color: #e9ecef;
        color: #495057;
    }

    .action-button.alert {
        background-color: #fff3cd;
        color: #856404;
    }

    .action-button.details {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .volume-chart {
        height: 300px;
        margin-top: 20px;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }

    .error-message {
        color: #dc3545;
        padding: 10px;
        background-color: #f8d7da;
        border-radius: 4px;
        margin: 10px 0;
    }

    .api-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .api-status.connected {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .api-status.error {
        background-color: #f8d7da;
        color: #842029;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    {% if not alpha_vantage_available %}
    <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">Alpha Vantage API Not Configured</h4>
        <p>To use the technical analysis features, please set the ALPHA_VANTAGE_API_KEY environment variable.</p>
        <hr>
        <p class="mb-0">You can still view the dashboard, but real-time data and analysis features will be limited.</p>
    </div>
    {% endif %}

    {{ components.tab_navigation([
        {'id': 'volume', 'label': 'Volume Analysis'},
        {'id': 'volatility', 'label': 'Volatility Analysis'},
        {'id': 'technical', 'label': 'Technical Analysis'}
    ]) }}

    <div id="volume" class="tab-content active">
        <div class="analysis-section">
            <div class="filters card">
                <h3>Volume Analysis Filters</h3>
                <div class="filter-group">
                    <label for="volume-timeframe">Timeframe</label>
                    <select id="volume-timeframe" class="form-control">
                        <option value="1d">1 Day</option>
                        <option value="5d">5 Days</option>
                        <option value="1m">1 Month</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="volume-min-price">Min Price</label>
                    <input type="number" id="volume-min-price" class="form-control" min="0" step="0.01">
                </div>
                <div class="filter-group">
                    <label for="volume-min-volume">Min Volume</label>
                    <input type="number" id="volume-min-volume" class="form-control" min="0">
                </div>
                <button id="volume-apply" class="btn btn-primary">
                    <i class="bi bi-funnel"></i> Apply Filters
                </button>
            </div>

            <div class="analysis-results">
                {{ components.chart_container('volume-chart', 'Volume Distribution') }}
                <div id="volumeStocks">
                    <!-- Volume analysis results will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <div id="volatility" class="tab-content">
        <div class="analysis-section">
            <div class="filters card">
                <h3>Volatility Analysis Filters</h3>
                <div class="filter-group">
                    <label for="volatility-timeframe">Timeframe</label>
                    <select id="volatility-timeframe" class="form-control">
                        <option value="1d">1 Day</option>
                        <option value="5d">5 Days</option>
                        <option value="1m">1 Month</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="volatility-min-price">Min Price</label>
                    <input type="number" id="volatility-min-price" class="form-control" min="0" step="0.01">
                </div>
                <div class="filter-group">
                    <label for="volatility-min-volume">Min Volume</label>
                    <input type="number" id="volatility-min-volume" class="form-control" min="0">
                </div>
                <button id="volatility-apply" class="btn btn-primary">
                    <i class="bi bi-funnel"></i> Apply Filters
                </button>
            </div>

            <div class="analysis-results">
                {{ components.chart_container('volatility-chart', 'Volatility Distribution') }}
                <div id="volatilityStocks">
                    <!-- Volatility analysis results will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <div id="technical" class="tab-content">
        <div class="analysis-section">
            <div class="filters card">
                <h3>Technical Analysis</h3>
                <div class="filter-group">
                    <label for="technical-symbol">Symbol</label>
                    <input type="text" id="technical-symbol" class="form-control" required>
                </div>
                <div class="filter-group">
                    <label for="technical-timeframe">Timeframe</label>
                    <select id="technical-timeframe" class="form-control">
                        <option value="1d">1 Day</option>
                        <option value="5d">5 Days</option>
                        <option value="1m">1 Month</option>
                        <option value="3m">3 Months</option>
                        <option value="6m">6 Months</option>
                        <option value="1y">1 Year</option>
                    </select>
                </div>
                <button id="technical-analyze" class="btn btn-primary">
                    <i class="bi bi-graph-up"></i> Analyze
                </button>
            </div>

            <div class="analysis-results">
                <div class="technical-metrics">
                    {{ components.metric_card('RSI', '0.00', None) }}
                    {{ components.metric_card('MACD', '0.00', None) }}
                    {{ components.metric_card('Bollinger Bands', '0.00', None) }}
                    {{ components.metric_card('Moving Average', '0.00', None) }}
                </div>

                <div class="technical-charts">
                    {{ components.chart_container('price-chart', 'Price Chart') }}
                    {{ components.chart_container('indicators-chart', 'Technical Indicators') }}
                </div>
            </div>
        </div>
    </div>
</div>

{{ components.api_status() }}
{% endblock %}

{% block extra_js %}
<script>
    let volumeChart;
    let volatilityChart;
    let priceChart;
    let indicatorsChart;

    // Volume Analysis Functions
    function loadVolumeAnalysis() {
        const container = document.getElementById('volumeStocks');
        container.innerHTML = '{{ components.loading_message() }}';

        const timeframe = document.getElementById('volume-timeframe').value;
        const minPrice = document.getElementById('volume-min-price').value;
        const minVolume = document.getElementById('volume-min-volume').value;

        fetch(`/api/analysis/volume?timeframe=${timeframe}&min_price=${minPrice}&min_volume=${minVolume}`)
            .then(response => response.json())
            .then(data => {
                container.innerHTML = '';
                
                if (data.stocks.length === 0) {
                    container.innerHTML = '<div class="empty-state">No stocks found matching criteria</div>';
                    return;
                }

                data.stocks.forEach(stock => {
                    const stockElement = createStockElement(stock);
                    container.appendChild(stockElement);
                });

                updateVolumeChart(data.distribution);
            })
            .catch(error => {
                console.error('Error loading volume analysis:', error);
                container.innerHTML = '{{ components.error_message("Error loading volume analysis. Please try again.") }}';
            });
    }

    function updateVolumeChart(data) {
        const ctx = document.getElementById('volume-chart').getContext('2d');
        
        if (volumeChart) {
            volumeChart.destroy();
        }
        
        volumeChart = new Chart(ctx, createChartConfig('bar', {
            labels: data.labels,
            datasets: [{
                label: 'Volume Distribution',
                data: data.values,
                backgroundColor: '#0d6efd',
                borderColor: '#0d6efd',
                borderWidth: 1
            }]
        }));
    }

    // Volatility Analysis Functions
    function loadVolatilityAnalysis() {
        const container = document.getElementById('volatilityStocks');
        container.innerHTML = '{{ components.loading_message() }}';

        const timeframe = document.getElementById('volatility-timeframe').value;
        const minPrice = document.getElementById('volatility-min-price').value;
        const minVolume = document.getElementById('volatility-min-volume').value;

        fetch(`/api/analysis/volatility?timeframe=${timeframe}&min_price=${minPrice}&min_volume=${minVolume}`)
            .then(response => response.json())
            .then(data => {
                container.innerHTML = '';
                
                if (data.stocks.length === 0) {
                    container.innerHTML = '<div class="empty-state">No stocks found matching criteria</div>';
                    return;
                }

                data.stocks.forEach(stock => {
                    const stockElement = createStockElement(stock);
                    container.appendChild(stockElement);
                });

                updateVolatilityChart(data.distribution);
            })
            .catch(error => {
                console.error('Error loading volatility analysis:', error);
                container.innerHTML = '{{ components.error_message("Error loading volatility analysis. Please try again.") }}';
            });
    }

    function updateVolatilityChart(data) {
        const ctx = document.getElementById('volatility-chart').getContext('2d');
        
        if (volatilityChart) {
            volatilityChart.destroy();
        }
        
        volatilityChart = new Chart(ctx, createChartConfig('bar', {
            labels: data.labels,
            datasets: [{
                label: 'Volatility Distribution',
                data: data.values,
                backgroundColor: '#dc3545',
                borderColor: '#dc3545',
                borderWidth: 1
            }]
        }));
    }

    // Technical Analysis Functions
    function loadTechnicalAnalysis() {
        const symbol = document.getElementById('technical-symbol').value;
        const timeframe = document.getElementById('technical-timeframe').value;

        if (!symbol) {
            showToast('Please enter a stock symbol', 'error');
            return;
        }

        fetch(`/api/analysis/technical?symbol=${symbol}&timeframe=${timeframe}`)
            .then(response => response.json())
            .then(data => {
                updateTechnicalMetrics(data.metrics);
                updatePriceChart(data.price_data);
                updateIndicatorsChart(data.indicators);
            })
            .catch(error => {
                console.error('Error loading technical analysis:', error);
                showToast('Error loading technical analysis', 'error');
            });
    }

    function updateTechnicalMetrics(metrics) {
        document.querySelector('[data-metric="RSI"]').textContent = metrics.rsi.toFixed(2);
        document.querySelector('[data-metric="MACD"]').textContent = metrics.macd.toFixed(2);
        document.querySelector('[data-metric="Bollinger Bands"]').textContent = metrics.bollinger.toFixed(2);
        document.querySelector('[data-metric="Moving Average"]').textContent = metrics.ma.toFixed(2);
    }

    function updatePriceChart(data) {
        const ctx = document.getElementById('price-chart').getContext('2d');
        
        if (priceChart) {
            priceChart.destroy();
        }
        
        priceChart = new Chart(ctx, createChartConfig('line', {
            labels: data.dates,
            datasets: [{
                label: 'Price',
                data: data.prices,
                borderColor: '#0d6efd',
                tension: 0.1
            }]
        }));
    }

    function updateIndicatorsChart(data) {
        const ctx = document.getElementById('indicators-chart').getContext('2d');
        
        if (indicatorsChart) {
            indicatorsChart.destroy();
        }
        
        indicatorsChart = new Chart(ctx, createChartConfig('line', {
            labels: data.dates,
            datasets: [{
                label: 'RSI',
                data: data.rsi,
                borderColor: '#198754',
                tension: 0.1
            }, {
                label: 'MACD',
                data: data.macd,
                borderColor: '#dc3545',
                tension: 0.1
            }]
        }));
    }

    function createStockElement(stock) {
        const element = document.createElement('div');
        element.className = 'stock-item';
        
        element.innerHTML = `
            <div class="stock-header">
                <span class="stock-symbol">${stock.symbol}</span>
                <span class="stock-price">$${stock.price.toFixed(2)}</span>
            </div>
            <div class="stock-details">
                <div class="detail">
                    <span class="label">Change</span>
                    <span class="value ${stock.change >= 0 ? 'positive' : 'negative'}">
                        ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}%
                    </span>
                </div>
                <div class="detail">
                    <span class="label">Volume</span>
                    <span class="value">${formatNumber(stock.volume)}</span>
                </div>
                <div class="detail">
                    <span class="label">Market Cap</span>
                    <span class="value">$${formatNumber(stock.market_cap)}</span>
                </div>
            </div>
            <div class="stock-actions">
                <button class="btn btn-sm btn-primary" onclick="addToWatchlist('${stock.symbol}')">
                    <i class="bi bi-plus-circle"></i> Watchlist
                </button>
                <button class="btn btn-sm btn-warning" onclick="setAlert('${stock.symbol}')">
                    <i class="bi bi-bell"></i> Alert
                </button>
            </div>
        `;
        
        return element;
    }

    // Event Listeners
    document.getElementById('volume-apply').addEventListener('click', loadVolumeAnalysis);
    document.getElementById('volatility-apply').addEventListener('click', loadVolatilityAnalysis);
    document.getElementById('technical-analyze').addEventListener('click', loadTechnicalAnalysis);

    // Initial Load
    loadVolumeAnalysis();
</script>
{% endblock %} 