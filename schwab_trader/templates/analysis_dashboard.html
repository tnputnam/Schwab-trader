{% extends "base.html" %}
{% import "components.html" as components %}

{% block title %}Analysis Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .tab-navigation {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }

    .tab-button {
        padding: 10px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.3s ease;
    }

    .tab-button.active {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .filter-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .stock-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .stock-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stock-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .stock-title {
        font-size: 1.2rem;
        font-weight: 500;
        color: #1a237e;
    }

    .stock-signal {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .signal-buy {
        background-color: #d4edda;
        color: #155724;
    }

    .signal-sell {
        background-color: #f8d7da;
        color: #721c24;
    }

    .signal-hold {
        background-color: #fff3cd;
        color: #856404;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .metric-card {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
    }

    .metric-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .metric-value {
        font-size: 1.1rem;
        font-weight: 500;
    }

    .chart-container {
        height: 300px;
        margin-top: 20px;
    }

    .alerts-section {
        margin-top: 20px;
    }

    .alert-card {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .alert-time {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .alert-message {
        font-size: 0.9rem;
        color: #856404;
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }

    .comparison-section {
        margin-top: 30px;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .comparison-chart {
        height: 400px;
        margin-top: 20px;
    }

    .test-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .test-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .test-results {
        margin-top: 20px;
    }

    .test-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .test-chart {
        height: 300px;
        margin-top: 20px;
    }

    .new-data-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .data-stream {
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
    }

    .data-point {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
    }

    .data-point:last-child {
        border-bottom: none;
    }

    .data-label {
        font-weight: 500;
        color: #6c757d;
    }

    .data-value {
        color: #212529;
    }

    .stream-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .stream-button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }

    .start-stream {
        background: #198754;
        color: white;
    }

    .stop-stream {
        background: #dc3545;
        color: white;
    }

    .clear-stream {
        background: #6c757d;
        color: white;
    }

    @media (max-width: 768px) {
        .stock-grid {
            grid-template-columns: 1fr;
        }

        .filter-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    {% if not alpha_vantage_available %}
    <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">Alpha Vantage API Not Configured</h4>
        <p>To use the technical analysis features, please set the ALPHA_VANTAGE_API_KEY environment variable.</p>
        <hr>
        <p class="mb-0">You can still view the dashboard, but real-time data and analysis features will be limited.</p>
    </div>
    {% else %}
    <div class="tab-navigation">
        <button class="tab-button {% if active_tab == 'volume' %}active{% endif %}" 
                onclick="showTab('volume')">Volume Analysis</button>
        <button class="tab-button {% if active_tab == 'technical' %}active{% endif %}" 
                onclick="showTab('technical')">Technical Analysis</button>
        <button class="tab-button {% if active_tab == 'fundamental' %}active{% endif %}" 
                onclick="showTab('fundamental')">Fundamental Analysis</button>
        <button class="tab-button {% if active_tab == 'testing' %}active{% endif %}" 
                onclick="showTab('testing')">Historical Testing</button>
        <button class="tab-button {% if active_tab == 'stream' %}active{% endif %}" 
                onclick="showTab('stream')">Live Data Stream</button>
    </div>

    <div id="volume-tab" class="tab-content {% if active_tab == 'volume' %}active{% endif %}">
        <div class="filter-section">
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="timeframe">Timeframe</label>
                    <select id="timeframe" class="form-select">
                        <option value="1m" {% if timeframe == '1m' %}selected{% endif %}>1 Month</option>
                        <option value="3m" {% if timeframe == '3m' %}selected{% endif %}>3 Months</option>
                        <option value="6m" {% if timeframe == '6m' %}selected{% endif %}>6 Months</option>
                        <option value="1y" {% if timeframe == '1y' %}selected{% endif %}>1 Year</option>
                        <option value="2y" {% if timeframe == '2y' %}selected{% endif %}>2 Years</option>
                        <option value="5y" {% if timeframe == '5y' %}selected{% endif %}>5 Years</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="volume-type">Volume Type</label>
                    <select id="volume-type" class="form-select">
                        <option value="raw" {% if volume_type == 'raw' %}selected{% endif %}>Raw Volume</option>
                        <option value="relative" {% if volume_type == 'relative' %}selected{% endif %}>Relative Volume</option>
                        <option value="sma" {% if volume_type == 'sma' %}selected{% endif %}>Volume SMA</option>
                    </select>
                </div>
            </div>
        </div>

        {% if api_errors %}
        <div class="error-message">
            <h5>API Errors</h5>
            <ul>
                {% for error in api_errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="stock-grid">
            {% for symbol, data in stock_data.items() %}
            <div class="stock-card">
                <div class="stock-header">
                    <h3 class="stock-title">{{ symbol }}</h3>
                    <span class="stock-signal signal-{{ data.analysis.signal|lower }}">
                        {{ data.analysis.signal }}
                    </span>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Current Volume</div>
                        <div class="metric-value">{{ data.analysis.current_volume|int }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Volume Baseline</div>
                        <div class="metric-value">{{ data.analysis.baseline|int }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Volume Ratio</div>
                        <div class="metric-value">{{ data.analysis.volume_ratio|round(2) }}x</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Momentum</div>
                        <div class="metric-value">{{ (data.analysis.details.volume_momentum * 100)|round(1) }}%</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="{{ symbol }}-volume-chart"></canvas>
                </div>

                {% if data.alerts %}
                <div class="alerts-section">
                    <h4>Volume Alerts</h4>
                    {% for alert in data.alerts %}
                    <div class="alert-card">
                        <div class="alert-message">{{ alert }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="comparison-section">
            <h3>Volume Comparison</h3>
            <div class="comparison-chart">
                <canvas id="volume-comparison-chart"></canvas>
            </div>
        </div>
    </div>

    <div id="technical-tab" class="tab-content {% if active_tab == 'technical' %}active{% endif %}">
        <!-- Technical analysis content will go here -->
    </div>

    <div id="fundamental-tab" class="tab-content {% if active_tab == 'fundamental' %}active{% endif %}">
        <!-- Fundamental analysis content will go here -->
    </div>

    <div id="testing-tab" class="tab-content {% if active_tab == 'testing' %}active{% endif %}">
        <div class="test-section">
            <h3>Historical Data Testing</h3>
            <div class="test-controls">
                <div class="control-group">
                    <label for="test-symbol">Symbol</label>
                    <select id="test-symbol" class="form-select">
                        {% for symbol in stock_data.keys() %}
                        <option value="{{ symbol }}">{{ symbol }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="control-group">
                    <label for="test-period">Test Period</label>
                    <select id="test-period" class="form-select">
                        <option value="1m">1 Month</option>
                        <option value="3m">3 Months</option>
                        <option value="6m">6 Months</option>
                        <option value="1y">1 Year</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="test-strategy">Strategy</label>
                    <select id="test-strategy" class="form-select">
                        <option value="volume">Volume Analysis</option>
                        <option value="technical">Technical Analysis</option>
                        <option value="combined">Combined Analysis</option>
                    </select>
                </div>
                <div class="control-group">
                    <button class="btn btn-primary" onclick="runTest()">Run Test</button>
                </div>
            </div>

            <div class="test-results" id="test-results" style="display: none;">
                <div class="test-metrics">
                    <div class="metric-card">
                        <div class="metric-label">Total Trades</div>
                        <div class="metric-value" id="total-trades">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value" id="win-rate">0%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Average Return</div>
                        <div class="metric-value" id="avg-return">0%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Max Drawdown</div>
                        <div class="metric-value" id="max-drawdown">0%</div>
                    </div>
                </div>

                <div class="test-chart">
                    <canvas id="test-performance-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="stream-tab" class="tab-content {% if active_tab == 'stream' %}active{% endif %}">
        <div class="new-data-section">
            <h3>Live Data Stream</h3>
            <div class="stream-controls">
                <button class="stream-button start-stream" onclick="startStream()">Start Stream</button>
                <button class="stream-button stop-stream" onclick="stopStream()">Stop Stream</button>
                <button class="stream-button clear-stream" onclick="clearStream()">Clear Data</button>
            </div>

            <div class="data-stream" id="data-stream">
                <div class="data-point">
                    <span class="data-label">Time</span>
                    <span class="data-label">Symbol</span>
                    <span class="data-label">Price</span>
                    <span class="data-label">Volume</span>
                    <span class="data-label">Signal</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{{ components.api_status() }}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`${tabName}-tab`).classList.add('active');
    document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
}

function runTest() {
    const symbol = document.getElementById('test-symbol').value;
    const period = document.getElementById('test-period').value;
    const strategy = document.getElementById('test-strategy').value;

    // Show loading state
    const results = document.getElementById('test-results');
    results.style.display = 'block';
    results.innerHTML = '<div class="loading">Running test...</div>';

    // Fetch test results
    fetch(`/api/test-strategy?symbol=${symbol}&period=${period}&strategy=${strategy}`)
        .then(response => response.json())
        .then(data => {
            // Update metrics
            document.getElementById('total-trades').textContent = data.total_trades;
            document.getElementById('win-rate').textContent = `${(data.win_rate * 100).toFixed(1)}%`;
            document.getElementById('avg-return').textContent = `${(data.avg_return * 100).toFixed(1)}%`;
            document.getElementById('max-drawdown').textContent = `${(data.max_drawdown * 100).toFixed(1)}%`;

            // Update performance chart
            const ctx = document.getElementById('test-performance-chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.performance.labels,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: data.performance.values,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Portfolio Value ($)'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            results.innerHTML = `<div class="error-message">Error running test: ${error.message}</div>`;
        });
}

let streamInterval;
function startStream() {
    if (streamInterval) return;
    
    streamInterval = setInterval(() => {
        fetch('/api/stream-data')
            .then(response => response.json())
            .then(data => {
                const stream = document.getElementById('data-stream');
                const point = document.createElement('div');
                point.className = 'data-point';
                point.innerHTML = `
                    <span class="data-value">${new Date().toLocaleTimeString()}</span>
                    <span class="data-value">${data.symbol}</span>
                    <span class="data-value">$${data.price.toFixed(2)}</span>
                    <span class="data-value">${data.volume.toLocaleString()}</span>
                    <span class="data-value signal-${data.signal.toLowerCase()}">${data.signal}</span>
                `;
                stream.insertBefore(point, stream.firstChild.nextSibling);
            })
            .catch(error => console.error('Stream error:', error));
    }, 1000);
}

function stopStream() {
    if (streamInterval) {
        clearInterval(streamInterval);
        streamInterval = null;
    }
}

function clearStream() {
    const stream = document.getElementById('data-stream');
    while (stream.children.length > 1) {
        stream.removeChild(stream.lastChild);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize individual stock charts
    {% for symbol, data in stock_data.items() %}
    const ctx = document.getElementById('{{ symbol }}-volume-chart').getContext('2d');
    const chartData = {
        labels: {{ data.historical_data|map(attribute='date')|list|tojson }},
        datasets: [{
            label: 'Volume',
            data: {{ data.volumes|tojson }},
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }, {
            label: 'Volume Baseline',
            data: {{ data.historical_data|map(attribute='volume_analysis.baseline')|list|tojson }},
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            fill: false,
            type: 'line'
        }]
    };
    
    new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Volume'
                    }
                }
            }
        }
    });
    {% endfor %}

    // Initialize comparison chart
    const comparisonCtx = document.getElementById('volume-comparison-chart').getContext('2d');
    const comparisonData = {
        labels: {{ stock_data.values()|first|attr('historical_data')|map(attribute='date')|list|tojson }},
        datasets: [
            {% for symbol, data in stock_data.items() %}
            {
                label: '{{ symbol }}',
                data: {{ data.volumes|tojson }},
                borderColor: getRandomColor(),
                borderWidth: 2,
                fill: false
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    new Chart(comparisonCtx, {
        type: 'line',
        data: comparisonData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Volume'
                    }
                }
            }
        }
    });

    // Filter change handlers
    document.getElementById('timeframe').addEventListener('change', updateFilters);
    document.getElementById('volume-type').addEventListener('change', updateFilters);

    function updateFilters() {
        const timeframe = document.getElementById('timeframe').value;
        const volumeType = document.getElementById('volume-type').value;
        window.location.href = `{{ url_for('analysis.volume_analysis') }}?timeframe=${timeframe}&volume_type=${volumeType}`;
    }

    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
});
</script>
{% endblock %} 