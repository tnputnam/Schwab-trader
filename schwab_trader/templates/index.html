{% extends "base.html" %}

{% block title %}Trading Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-content {
        display: none;
    }
    .dashboard-content.active {
        display: block;
    }
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .stat-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-card .label {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
    }
    .stat-card .value {
        font-size: 24px;
        font-weight: bold;
    }
    .stat-card .value.positive {
        color: #28a745;
    }
    .stat-card .value.negative {
        color: #dc3545;
    }
    .market-overview {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .market-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    .market-stat {
        text-align: center;
        padding: 10px;
    }
    .market-stat .label {
        font-size: 12px;
        color: #666;
    }
    .market-stat .value {
        font-size: 18px;
        font-weight: bold;
    }
    .top-movers {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    .mover-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .mover-card h3 {
        font-size: 16px;
        margin-bottom: 10px;
    }
    .mover-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .mover-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    .mover-item:last-child {
        border-bottom: none;
    }
    .mover-symbol {
        font-weight: bold;
    }
    .mover-change.positive {
        color: #28a745;
    }
    .mover-change.negative {
        color: #dc3545;
    }
    /* Portfolio, Watchlist, and Alerts styles */
    .portfolio-section, .watchlist-section, .alerts-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .portfolio-table, .watchlist-table, .alerts-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    .portfolio-table th, .watchlist-table th, .alerts-table th {
        background: #f8f9fa;
        padding: 10px;
        text-align: left;
        border-bottom: 2px solid #dee2e6;
    }
    .portfolio-table td, .watchlist-table td, .alerts-table td {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .action-button {
        padding: 5px 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
    }
    .action-button:hover {
        background: #0056b3;
    }
    .action-button.danger {
        background: #dc3545;
    }
    .action-button.danger:hover {
        background: #c82333;
    }
    .alert-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .alert-item:last-child {
        border-bottom: none;
    }
    .alert-info {
        flex-grow: 1;
    }
    .alert-actions {
        display: flex;
        gap: 10px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group input, .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }
    .modal-content {
        background: white;
        width: 400px;
        margin: 100px auto;
        padding: 20px;
        border-radius: 8px;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .close-button {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="market-overview">
        <h2>Market Overview</h2>
        <div class="market-stats" id="marketStats">
            <!-- Market stats will be populated by JavaScript -->
        </div>
    </div>

    <div class="top-movers">
        <div class="mover-card">
            <h3>Top Gainers</h3>
            <ul class="mover-list" id="topGainers">
                <!-- Top gainers will be populated by JavaScript -->
            </ul>
        </div>
        <div class="mover-card">
            <h3>Top Losers</h3>
            <ul class="mover-list" id="topLosers">
                <!-- Top losers will be populated by JavaScript -->
            </ul>
        </div>
    </div>

    <div class="quick-stats">
        <div class="stat-card">
            <div class="label">Total Portfolio Value</div>
            <div class="value" id="totalPortfolio">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="label">Today's P/L</div>
            <div class="value" id="todayPL">$0.00</div>
        </div>
        <div class="stat-card">
            <div class="label">Active Positions</div>
            <div class="value" id="activePositions">0</div>
        </div>
        <div class="stat-card">
            <div class="label">Total Trades</div>
            <div class="value" id="totalTrades">0</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to format currency
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(value);
    }

    // Function to format percentage
    function formatPercentage(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'percent',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value / 100);
    }

    // Function to update market data
    async function updateMarketData() {
        try {
            const response = await fetch('/api/market_data');
            const data = await response.json();

            if (data.status === 'success') {
                // Update market stats
                const marketStats = document.getElementById('marketStats');
                marketStats.innerHTML = '';

                // Add market status
                const marketStatus = document.createElement('div');
                marketStatus.className = 'market-stat';
                marketStatus.innerHTML = `
                    <div class="label">Market Status</div>
                    <div class="value">${data.market_status.market}</div>
                `;
                marketStats.appendChild(marketStatus);

                // Add indices
                for (const [symbol, quote] of Object.entries(data.indices)) {
                    const change = parseFloat(quote['Global Quote']['10. change percent'].replace('%', ''));
                    const stat = document.createElement('div');
                    stat.className = 'market-stat';
                    stat.innerHTML = `
                        <div class="label">${symbol}</div>
                        <div class="value ${change >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(parseFloat(quote['Global Quote']['05. price']))}
                            <small>(${formatPercentage(change)})</small>
                        </div>
                    `;
                    marketStats.appendChild(stat);
                }

                // Update top gainers
                const topGainers = document.getElementById('topGainers');
                topGainers.innerHTML = '';
                data.movers.top_gainers.slice(0, 5).forEach(mover => {
                    const li = document.createElement('li');
                    li.className = 'mover-item';
                    li.innerHTML = `
                        <span class="mover-symbol">${mover.ticker}</span>
                        <span class="mover-change positive">+${mover.change_percentage}%</span>
                    `;
                    topGainers.appendChild(li);
                });

                // Update top losers
                const topLosers = document.getElementById('topLosers');
                topLosers.innerHTML = '';
                data.movers.top_losers.slice(0, 5).forEach(mover => {
                    const li = document.createElement('li');
                    li.className = 'mover-item';
                    li.innerHTML = `
                        <span class="mover-symbol">${mover.ticker}</span>
                        <span class="mover-change negative">${mover.change_percentage}%</span>
                    `;
                    topLosers.appendChild(li);
                });
            }
        } catch (error) {
            console.error('Error updating market data:', error);
        }
    }

    // Update market data every 5 minutes
    updateMarketData();
    setInterval(updateMarketData, 300000);

    // Function to update portfolio stats
    async function updatePortfolioStats() {
        try {
            const response = await fetch('/api/portfolio/stats');
            const data = await response.json();

            if (data.status === 'success') {
                document.getElementById('totalPortfolio').textContent = formatCurrency(data.total_value);
                document.getElementById('todayPL').textContent = formatCurrency(data.today_pl);
                document.getElementById('todayPL').className = `value ${data.today_pl >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('activePositions').textContent = data.active_positions;
                document.getElementById('totalTrades').textContent = data.total_trades;
            }
        } catch (error) {
            console.error('Error updating portfolio stats:', error);
        }
    }

    // Update portfolio stats every minute
    updatePortfolioStats();
    setInterval(updatePortfolioStats, 60000);
</script>
{% endblock %} 