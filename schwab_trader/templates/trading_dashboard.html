{% extends "base.html" %}
{% import "components.html" as components %}

{% block title %}Trading Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Tab Navigation */
    .nav-tabs {
        margin-bottom: 20px;
        border-bottom: 2px solid #dee2e6;
    }
    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        padding: 10px 20px;
        margin-right: 10px;
        border-radius: 4px;
    }
    .nav-tabs .nav-link.active {
        color: #007bff;
        background-color: #f8f9fa;
        border-bottom: 2px solid #007bff;
    }
    .nav-tabs .nav-link:hover:not(.active) {
        color: #0056b3;
        background-color: #f8f9fa;
    }
    
    /* Common Panel Styles */
    .panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    /* Trading Controls */
    .trading-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    .button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .button:hover {
        background: #0056b3;
    }
    .button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    .button.stop {
        background: #dc3545;
    }
    .button.stop:hover {
        background: #c82333;
    }
    
    /* Order Form */
    .order-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #666;
    }
    .form-group input, .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    .order-type-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    .order-type-btn {
        flex: 1;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        text-align: center;
    }
    .order-type-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    /* Settings */
    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    .setting-group {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
    }
    .setting-group h4 {
        margin-bottom: 10px;
        color: #495057;
    }
    .setting-item {
        margin-bottom: 10px;
    }
    .setting-item label {
        display: block;
        margin-bottom: 5px;
        color: #666;
    }
    .setting-item input {
        width: 100%;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    
    /* Status Indicators */
    .status {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .status.running {
        background-color: #d4edda;
        color: #155724;
    }
    .status.stopped {
        background-color: #f8d7da;
        color: #721c24;
    }
    .api-status {
        margin-bottom: 20px;
        padding: 10px;
        border-radius: 4px;
        background: #e9ecef;
    }
    .api-status.connected {
        background: #d4edda;
        color: #155724;
    }
    .api-status.error {
        background: #f8d7da;
        color: #721c24;
    }
    
    /* Trade List */
    .trade-list {
        max-height: 400px;
        overflow-y: auto;
    }
    .trade-item {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .trade-item:last-child {
        border-bottom: none;
    }
    .trade-buy {
        background-color: rgba(40, 167, 69, 0.1);
    }
    .trade-sell {
        background-color: rgba(220, 53, 69, 0.1);
    }
    
    /* Metrics Grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .metric-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        transition: transform 0.2s ease;
    }
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .metric-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
    }
    .metric-value {
        font-size: 18px;
        font-weight: bold;
    }
    .metric-value.positive {
        color: #28a745;
    }
    .metric-value.negative {
        color: #dc3545;
    }
    
    /* Charts */
    .chart-container {
        height: 300px;
        margin-top: 20px;
    }
    
    /* Loading and Error States */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0,0,0,.1);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .error-message {
        color: #dc3545;
        margin-top: 10px;
        padding: 10px;
        background: #f8d7da;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    {{ components.tab_navigation([
        {'id': 'manual', 'label': 'Manual Trading'},
        {'id': 'automated', 'label': 'Automated Trading'}
    ]) }}

    <div id="manual" class="tab-content active">
        <div class="trading-section">
            <div class="order-form card">
                <h3>Place Order</h3>
                <form id="orderForm">
                    <div class="form-group">
                        <label for="symbol">Symbol</label>
                        <input type="text" id="symbol" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="orderType">Order Type</label>
                        <select id="orderType" class="form-control" required>
                            <option value="market">Market</option>
                            <option value="limit">Limit</option>
                            <option value="stop">Stop</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="side">Side</label>
                        <select id="side" class="form-control" required>
                            <option value="buy">Buy</option>
                            <option value="sell">Sell</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" class="form-control" min="1" required>
                    </div>
                    <div class="form-group" id="priceGroup" style="display: none;">
                        <label for="price">Price</label>
                        <input type="number" id="price" class="form-control" min="0" step="0.01">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Place Order
                    </button>
                </form>
            </div>

            <div class="orders-section">
                <div class="open-orders card">
                    <h3>Open Orders</h3>
                    <div id="openOrders">
                        <!-- Open orders will be loaded here -->
                    </div>
                </div>

                <div class="recent-trades card">
                    <h3>Recent Trades</h3>
                    <div id="recentTrades">
                        <!-- Recent trades will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="automated" class="tab-content">
        <div class="trading-section">
            <div class="strategy-controls card">
                <h3>Automated Trading Controls</h3>
                <div class="controls">
                    <button id="startTrading" class="btn btn-success">
                        <i class="bi bi-play-circle"></i> Start Trading
                    </button>
                    <button id="stopTrading" class="btn btn-danger" disabled>
                        <i class="bi bi-stop-circle"></i> Stop Trading
                    </button>
                </div>
                <div class="status">
                    <span id="tradingStatus" class="badge bg-secondary">Not Running</span>
                </div>
            </div>

            <div class="performance-metrics">
                {{ components.metric_card('Total Trades', '0', null) }}
                {{ components.metric_card('Win Rate', '0%', null) }}
                {{ components.metric_card('Profit/Loss', '$0.00', null) }}
                {{ components.metric_card('Average Return', '0%', null) }}
            </div>

            <div class="performance-charts">
                {{ components.chart_container('equity-chart', 'Equity Curve') }}
                {{ components.chart_container('returns-chart', 'Daily Returns') }}
            </div>
        </div>
    </div>
</div>

{{ components.api_status() }}
{% endblock %}

{% block extra_js %}
<script>
    let equityChart;
    let returnsChart;

    // Manual Trading Functions
    function loadOpenOrders() {
        const container = document.getElementById('openOrders');
        container.innerHTML = '{{ components.loading_message() }}';

        fetch('/api/trading/orders')
            .then(response => response.json())
            .then(data => {
                container.innerHTML = '';
                
                if (data.orders.length === 0) {
                    container.innerHTML = '<div class="empty-state">No open orders</div>';
                    return;
                }

                data.orders.forEach(order => {
                    const orderElement = createOrderElement(order);
                    container.appendChild(orderElement);
                });
            })
            .catch(error => {
                console.error('Error loading open orders:', error);
                container.innerHTML = '{{ components.error_message("Error loading open orders. Please try again.") }}';
            });
    }

    function loadRecentTrades() {
        const container = document.getElementById('recentTrades');
        container.innerHTML = '{{ components.loading_message() }}';

        fetch('/api/trading/trades')
            .then(response => response.json())
            .then(data => {
                container.innerHTML = '';
                
                if (data.trades.length === 0) {
                    container.innerHTML = '<div class="empty-state">No recent trades</div>';
                    return;
                }

                data.trades.forEach(trade => {
                    const tradeElement = createTradeElement(trade);
                    container.appendChild(tradeElement);
                });
            })
            .catch(error => {
                console.error('Error loading recent trades:', error);
                container.innerHTML = '{{ components.error_message("Error loading recent trades. Please try again.") }}';
            });
    }

    function createOrderElement(order) {
        const element = document.createElement('div');
        element.className = 'order-item';
        
        element.innerHTML = `
            <div class="order-header">
                <span class="order-symbol">${order.symbol}</span>
                <span class="order-type ${order.side}">${order.side.toUpperCase()} ${order.type.toUpperCase()}</span>
            </div>
            <div class="order-details">
                <div class="detail">
                    <span class="label">Quantity</span>
                    <span class="value">${order.quantity}</span>
                </div>
                <div class="detail">
                    <span class="label">Price</span>
                    <span class="value">$${order.price.toFixed(2)}</span>
                </div>
                <div class="detail">
                    <span class="label">Status</span>
                    <span class="value">${order.status}</span>
                </div>
            </div>
            <div class="order-actions">
                <button class="btn btn-sm btn-danger" onclick="cancelOrder('${order.id}')">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
            </div>
        `;
        
        return element;
    }

    function createTradeElement(trade) {
        const element = document.createElement('div');
        element.className = 'trade-item';
        
        element.innerHTML = `
            <div class="trade-header">
                <span class="trade-symbol">${trade.symbol}</span>
                <span class="trade-side ${trade.side}">${trade.side.toUpperCase()}</span>
            </div>
            <div class="trade-details">
                <div class="detail">
                    <span class="label">Quantity</span>
                    <span class="value">${trade.quantity}</span>
                </div>
                <div class="detail">
                    <span class="label">Price</span>
                    <span class="value">$${trade.price.toFixed(2)}</span>
                </div>
                <div class="detail">
                    <span class="label">P/L</span>
                    <span class="value ${trade.pl >= 0 ? 'positive' : 'negative'}">
                        ${trade.pl >= 0 ? '+' : ''}$${trade.pl.toFixed(2)}
                    </span>
                </div>
            </div>
            <div class="trade-time">
                ${new Date(trade.timestamp).toLocaleString()}
            </div>
        `;
        
        return element;
    }

    // Automated Trading Functions
    function loadTradingStatus() {
        fetch('/api/trading/status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('tradingStatus');
                const startButton = document.getElementById('startTrading');
                const stopButton = document.getElementById('stopTrading');

                if (data.running) {
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = 'Running';
                    startButton.disabled = true;
                    stopButton.disabled = false;
                } else {
                    statusElement.className = 'badge bg-secondary';
                    statusElement.textContent = 'Not Running';
                    startButton.disabled = false;
                    stopButton.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error loading trading status:', error);
                showToast('Error loading trading status', 'error');
            });
    }

    function loadPerformanceMetrics() {
        fetch('/api/trading/performance')
            .then(response => response.json())
            .then(data => {
                document.querySelector('[data-metric="Total Trades"]').textContent = data.total_trades;
                document.querySelector('[data-metric="Win Rate"]').textContent = `${data.win_rate}%`;
                document.querySelector('[data-metric="Profit/Loss"]').textContent = `$${data.profit_loss.toFixed(2)}`;
                document.querySelector('[data-metric="Average Return"]').textContent = `${data.avg_return}%`;
            })
            .catch(error => {
                console.error('Error loading performance metrics:', error);
                showToast('Error loading performance metrics', 'error');
            });
    }

    function updateEquityChart(data) {
        const ctx = document.getElementById('equity-chart').getContext('2d');
        
        if (equityChart) {
            equityChart.destroy();
        }
        
        equityChart = new Chart(ctx, createChartConfig('line', {
            labels: data.dates,
            datasets: [{
                label: 'Equity',
                data: data.equity,
                borderColor: '#0d6efd',
                tension: 0.1
            }]
        }));
    }

    function updateReturnsChart(data) {
        const ctx = document.getElementById('returns-chart').getContext('2d');
        
        if (returnsChart) {
            returnsChart.destroy();
        }
        
        returnsChart = new Chart(ctx, createChartConfig('bar', {
            labels: data.dates,
            datasets: [{
                label: 'Returns',
                data: data.returns,
                backgroundColor: data.returns.map(r => r >= 0 ? '#198754' : '#dc3545'),
                borderColor: data.returns.map(r => r >= 0 ? '#198754' : '#dc3545'),
                borderWidth: 1
            }]
        }));
    }

    // Event Listeners
    document.getElementById('orderType').addEventListener('change', (e) => {
        document.getElementById('priceGroup').style.display = 
            e.target.value === 'market' ? 'none' : 'block';
    });

    document.getElementById('orderForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const order = {
            symbol: document.getElementById('symbol').value,
            type: document.getElementById('orderType').value,
            side: document.getElementById('side').value,
            quantity: parseInt(document.getElementById('quantity').value),
            price: document.getElementById('orderType').value === 'market' ? 
                null : parseFloat(document.getElementById('price').value)
        };
        
        fetch('/api/trading/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(order)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Order placed successfully');
                loadOpenOrders();
                document.getElementById('orderForm').reset();
            } else {
                showToast('Error: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error placing order:', error);
            showToast('Error placing order', 'error');
        });
    });

    document.getElementById('startTrading').addEventListener('click', () => {
        fetch('/api/trading/start', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Automated trading started');
                loadTradingStatus();
            } else {
                showToast('Error: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error starting trading:', error);
            showToast('Error starting trading', 'error');
        });
    });

    document.getElementById('stopTrading').addEventListener('click', () => {
        fetch('/api/trading/stop', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Automated trading stopped');
                loadTradingStatus();
            } else {
                showToast('Error: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error stopping trading:', error);
            showToast('Error stopping trading', 'error');
        });
    });

    // Initial Load
    loadOpenOrders();
    loadRecentTrades();
    loadTradingStatus();
    loadPerformanceMetrics();
</script>
{% endblock %} 