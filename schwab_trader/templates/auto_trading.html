{% extends "base.html" %}

{% block title %}Volume-Based Auto Trading Dashboard{% endblock %}

{% block extra_css %}
<style>
    .control-panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .performance-panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .trades-panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
    }
    .button:hover {
        background: #0056b3;
    }
    .button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    .button.stop {
        background: #dc3545;
    }
    .button.stop:hover {
        background: #c82333;
    }
    .button.secondary {
        background: #6c757d;
    }
    .button.secondary:hover {
        background: #5a6268;
    }
    .metric {
        display: inline-block;
        margin-right: 20px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    .metric-label {
        font-size: 12px;
        color: #666;
    }
    .metric-value {
        font-size: 18px;
        font-weight: bold;
    }
    .positive {
        color: #28a745;
    }
    .negative {
        color: #dc3545;
    }
    .chart-container {
        height: 300px;
        margin-top: 20px;
        position: relative;
    }
    .chart-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
    }
    .trade-list {
        max-height: 400px;
        overflow-y: auto;
    }
    .trade-item {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .trade-item:last-child {
        border-bottom: none;
    }
    .trade-buy {
        background-color: rgba(40, 167, 69, 0.1);
    }
    .trade-sell {
        background-color: rgba(220, 53, 69, 0.1);
    }
    .status {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    .status.running {
        background-color: #d4edda;
        color: #155724;
    }
    .status.stopped {
        background-color: #f8d7da;
        color: #721c24;
    }
    .strategy-settings {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    .strategy-settings label {
        display: block;
        margin-bottom: 5px;
    }
    .strategy-settings input {
        width: 100px;
        padding: 5px;
        margin-bottom: 10px;
    }
    .symbol-search {
        margin-bottom: 20px;
    }
    .symbol-search input {
        width: 200px;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .symbol-search button {
        padding: 8px 15px;
        margin-left: 10px;
    }
    .search-results {
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
    }
    .search-result-item {
        padding: 8px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
    }
    .search-result-item:hover {
        background-color: #f8f9fa;
    }
    .selected-symbols {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    .selected-symbol {
        display: inline-block;
        margin: 5px;
        padding: 5px 10px;
        background: #e9ecef;
        border-radius: 4px;
    }
    .selected-symbol button {
        margin-left: 5px;
        padding: 2px 5px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    .selected-symbol button:hover {
        background: #c82333;
    }
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0,0,0,.1);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
        margin-left: 10px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .error-message {
        color: #dc3545;
        margin-top: 5px;
        font-size: 14px;
    }
    .settings-panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .risk-management {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .strategy-summary {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .price-updates {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    .price-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid #eee;
    }
    .price-item:last-child {
        border-bottom: none;
    }
    .export-options {
        margin-top: 10px;
    }
    .export-button {
        margin-right: 10px;
    }
    .risk-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }
    .risk-low {
        background-color: #28a745;
    }
    .risk-medium {
        background-color: #ffc107;
    }
    .risk-high {
        background-color: #dc3545;
    }
    .strategy-metric {
        margin-bottom: 10px;
    }
    .strategy-metric-label {
        font-weight: bold;
        margin-right: 10px;
    }
    .api-settings {
        margin-top: 15px;
    }
    .api-settings input {
        width: 200px;
        margin-right: 10px;
    }
    .websocket-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-left: 5px;
    }
    .websocket-connected {
        background-color: #28a745;
    }
    .websocket-disconnected {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Volume-Based Auto Trading Dashboard</h1>
    
    <div class="settings-panel">
        <h2>API Settings</h2>
        <div class="api-settings">
            <label for="alpha-vantage-key">Alpha Vantage API Key:</label>
            <input type="password" id="alpha-vantage-key" placeholder="Enter your API key">
            <button class="button" id="save-api-key">Save</button>
            <span id="api-status"></span>
        </div>
    </div>
    
    <div class="control-panel">
        <h2>Control Panel</h2>
        <div class="status" id="trading-status">Status: Stopped</div>
        <button class="button" id="start-button">Start Trading</button>
        <button class="button stop" id="stop-button" disabled>Stop Trading</button>
        
        <div class="symbol-search">
            <h3>Stock Selection</h3>
            <input type="text" id="symbol-search" placeholder="Search for a stock symbol...">
            <button class="button" id="search-button">Search</button>
            <div id="search-loading" class="loading" style="display: none;"></div>
            <div class="error-message" id="search-error"></div>
            <div class="search-results" id="search-results"></div>
            <div class="selected-symbols" id="selected-symbols">
                <h4>Selected Stocks</h4>
                <!-- Selected symbols will be added here -->
            </div>
        </div>
        
        <div class="strategy-settings">
            <h3>Strategy Settings</h3>
            <label for="buy-threshold">Buy Threshold (volume ratio):</label>
            <input type="number" id="buy-threshold" value="1.15" step="0.01" min="1.0">
            
            <label for="sell-threshold">Sell Threshold (volume ratio):</label>
            <input type="number" id="sell-threshold" value="1.05" step="0.01" min="1.0">
            
            <label for="lookback-period">Lookback Period (days):</label>
            <input type="number" id="lookback-period" value="30" min="10" max="90">
        </div>
        
        <div style="margin-top: 20px;">
            <div class="metric">
                <div class="metric-label">Initial Budget</div>
                <div class="metric-value">$2,000.00</div>
            </div>
            <div class="metric">
                <div class="metric-label">Current Balance</div>
                <div class="metric-value" id="current-balance">$2,000.00</div>
            </div>
            <div class="metric">
                <div class="metric-label">Total Profit/Loss</div>
                <div class="metric-value" id="total-pl">$0.00</div>
            </div>
            <div class="metric">
                <div class="metric-label">Active Positions</div>
                <div class="metric-value" id="active-positions">0</div>
            </div>
        </div>
        
        <div class="price-updates" id="price-updates">
            <h4>Real-time Prices</h4>
            <!-- Price updates will be added here -->
        </div>
    </div>

    <div class="risk-management">
        <h2>Risk Management</h2>
        <div class="strategy-settings">
            <label for="max-position-size">Maximum Position Size (%):</label>
            <input type="number" id="max-position-size" value="20" min="1" max="100">
            
            <label for="stop-loss">Stop Loss (%):</label>
            <input type="number" id="stop-loss" value="5" min="1" max="50">
            
            <label for="take-profit">Take Profit (%):</label>
            <input type="number" id="take-profit" value="10" min="1" max="100">
            
            <div class="risk-indicator" id="risk-indicator"></div>
            <span id="risk-level">Risk Level: Medium</span>
        </div>
    </div>

    <div class="strategy-summary">
        <h2>Strategy Performance</h2>
        <div class="strategy-metric">
            <span class="strategy-metric-label">Win Rate:</span>
            <span id="win-rate">0%</span>
        </div>
        <div class="strategy-metric">
            <span class="strategy-metric-label">Average Return:</span>
            <span id="avg-return">0%</span>
        </div>
        <div class="strategy-metric">
            <span class="strategy-metric-label">Sharpe Ratio:</span>
            <span id="sharpe-ratio">0.00</span>
        </div>
        <div class="strategy-metric">
            <span class="strategy-metric-label">Maximum Drawdown:</span>
            <span id="max-drawdown">0%</span>
        </div>
    </div>

    <div class="performance-panel">
        <h2>Performance</h2>
        <div class="chart-container">
            <div class="chart-controls">
                <button class="button secondary" id="refresh-chart">Refresh</button>
                <div id="chart-loading" class="loading" style="display: none;"></div>
            </div>
            <canvas id="performance-chart"></canvas>
        </div>
    </div>

    <div class="trades-panel">
        <h2>Recent Trades</h2>
        <div class="export-options">
            <button class="button export-button" id="export-csv">Export CSV</button>
            <button class="button export-button" id="export-json">Export JSON</button>
        </div>
        <div class="trade-list" id="trade-list">
            <!-- Trades will be added here dynamically -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let performanceChart = null;
    let tradingActive = false;
    const initialBudget = 2000;
    let currentBalance = initialBudget;
    let tradeHistory = [];
    let selectedSymbols = new Set();
    let apiRateLimit = 0;
    let websocket = null;
    let apiKey = localStorage.getItem('alphaVantageKey') || '';

    // Initialize performance chart
    function initPerformanceChart() {
        const ctx = document.getElementById('performance-chart').getContext('2d');
        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Portfolio Value',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }

    // Search for stocks using Alpha Vantage API
    async function searchStocks(query) {
        if (apiRateLimit > 0) {
            document.getElementById('search-error').textContent = 'API rate limit reached. Please try again later.';
            return;
        }

        const searchLoading = document.getElementById('search-loading');
        const searchError = document.getElementById('search-error');
        
        searchLoading.style.display = 'inline-block';
        searchError.textContent = '';
        
        try {
            const response = await fetch(`/api/alpha_vantage/search?query=${encodeURIComponent(query)}`);
            if (!response.ok) {
                if (response.status === 429) {
                    apiRateLimit = 60; // 1 minute cooldown
                    searchError.textContent = 'API rate limit reached. Please try again in 1 minute.';
                    setTimeout(() => {
                        apiRateLimit = 0;
                        searchError.textContent = '';
                    }, 60000);
                } else {
                    throw new Error('Search failed');
                }
                return;
            }
            
            const data = await response.json();
            displaySearchResults(data);
        } catch (error) {
            console.error('Error searching stocks:', error);
            searchError.textContent = 'Failed to search for stocks. Please try again.';
        } finally {
            searchLoading.style.display = 'none';
        }
    }

    // Display search results
    function displaySearchResults(results) {
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '';
        
        if (results.length === 0) {
            resultsContainer.innerHTML = '<div class="search-result-item">No results found</div>';
            return;
        }
        
        results.forEach(result => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.innerHTML = `
                <strong>${result.symbol}</strong> - ${result.name}
                <br>${result.region} | ${result.currency}
            `;
            item.addEventListener('click', () => selectSymbol(result.symbol));
            resultsContainer.appendChild(item);
        });
    }

    // Select a symbol for trading
    function selectSymbol(symbol) {
        if (selectedSymbols.has(symbol)) return;
        
        selectedSymbols.add(symbol);
        updateSelectedSymbolsDisplay();
        document.getElementById('symbol-search').value = '';
        document.getElementById('search-results').innerHTML = '';
        
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            websocket.send(JSON.stringify({
                type: 'subscribe',
                symbols: [symbol]
            }));
        }
    }

    // Remove a selected symbol
    function removeSymbol(symbol) {
        selectedSymbols.delete(symbol);
        updateSelectedSymbolsDisplay();
        
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            websocket.send(JSON.stringify({
                type: 'unsubscribe',
                symbols: [symbol]
            }));
        }
    }

    // Update the display of selected symbols
    function updateSelectedSymbolsDisplay() {
        const container = document.getElementById('selected-symbols');
        const symbolsList = container.querySelector('div');
        
        if (symbolsList) {
            symbolsList.innerHTML = '';
        } else {
            const newList = document.createElement('div');
            container.appendChild(newList);
        }
        
        selectedSymbols.forEach(symbol => {
            const symbolElement = document.createElement('div');
            symbolElement.className = 'selected-symbol';
            symbolElement.innerHTML = `
                ${symbol}
                <button onclick="removeSymbol('${symbol}')">Ã—</button>
            `;
            container.querySelector('div').appendChild(symbolElement);
        });
    }

    // Refresh performance chart
    async function refreshChart() {
        const chartLoading = document.getElementById('chart-loading');
        chartLoading.style.display = 'inline-block';
        
        try {
            const response = await fetch('/api/auto_trading/performance');
            if (!response.ok) throw new Error('Failed to fetch performance data');
            
            const data = await response.json();
            updatePerformanceChart(data);
        } catch (error) {
            console.error('Error refreshing chart:', error);
            alert('Failed to refresh performance data');
        } finally {
            chartLoading.style.display = 'none';
        }
    }

    // Update performance chart with new data
    function updatePerformanceChart(data) {
        const labels = data.map(point => point.timestamp);
        const values = data.map(point => point.value);
        
        performanceChart.data.labels = labels;
        performanceChart.data.datasets[0].data = values;
        performanceChart.update();
    }

    // Add trade to history
    function addTrade(trade) {
        tradeHistory.push(trade);
        updatePerformanceChart(tradeHistory);
        calculateStrategyMetrics();
        
        const tradeList = document.getElementById('trade-list');
        const tradeItem = document.createElement('div');
        tradeItem.className = `trade-item trade-${trade.type.toLowerCase()}`;
        tradeItem.innerHTML = `
            <strong>${trade.timestamp}</strong> - ${trade.type} ${trade.symbol} @ $${trade.price.toFixed(2)}
            <br>Quantity: ${trade.quantity} | Total: $${(trade.price * trade.quantity).toFixed(2)}
        `;
        tradeList.insertBefore(tradeItem, tradeList.firstChild);
    }

    // Update metrics
    function updateMetrics() {
        document.getElementById('current-balance').textContent = `$${currentBalance.toFixed(2)}`;
        
        const totalPL = currentBalance - initialBudget;
        const plElement = document.getElementById('total-pl');
        plElement.textContent = `$${totalPL.toFixed(2)}`;
        plElement.className = `metric-value ${totalPL >= 0 ? 'positive' : 'negative'}`;
        
        const activePositions = tradeHistory.filter(trade => trade.type === 'BUY').length -
                              tradeHistory.filter(trade => trade.type === 'SELL').length;
        document.getElementById('active-positions').textContent = activePositions;
    }

    // Start trading
    async function startTrading() {
        if (tradingActive) return;
        
        const buyThreshold = parseFloat(document.getElementById('buy-threshold').value);
        const sellThreshold = parseFloat(document.getElementById('sell-threshold').value);
        const lookbackPeriod = parseInt(document.getElementById('lookback-period').value);
        
        if (selectedSymbols.size === 0) {
            alert('Please select at least one stock to trade');
            return;
        }
        
        try {
            const response = await fetch('/api/auto_trading/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    symbols: Array.from(selectedSymbols),
                    buyThreshold,
                    sellThreshold,
                    lookbackPeriod
                })
            });
            
            if (response.ok) {
                tradingActive = true;
                updateStatus('Running');
                document.getElementById('start-button').disabled = true;
                document.getElementById('stop-button').disabled = false;
            }
        } catch (error) {
            console.error('Error starting trading:', error);
            alert('Failed to start trading');
        }
    }

    // Stop trading
    async function stopTrading() {
        if (!tradingActive) return;
        
        try {
            const response = await fetch('/api/auto_trading/stop', {
                method: 'POST'
            });
            
            if (response.ok) {
                tradingActive = false;
                updateStatus('Stopped');
                document.getElementById('start-button').disabled = false;
                document.getElementById('stop-button').disabled = true;
            }
        } catch (error) {
            console.error('Error stopping trading:', error);
            alert('Failed to stop trading');
        }
    }

    // Update status display
    function updateStatus(status) {
        const statusElement = document.getElementById('trading-status');
        statusElement.textContent = `Status: ${status}`;
        statusElement.className = `status ${status.toLowerCase()}`;
    }

    // Initialize WebSocket connection
    function initWebSocket() {
        websocket = new WebSocket('ws://' + window.location.host + '/ws/prices');
        
        websocket.onopen = () => {
            document.getElementById('api-status').innerHTML = 
                'Connected <span class="websocket-status websocket-connected"></span>';
            if (selectedSymbols.size > 0) {
                websocket.send(JSON.stringify({
                    type: 'subscribe',
                    symbols: Array.from(selectedSymbols)
                }));
            }
        };
        
        websocket.onclose = () => {
            document.getElementById('api-status').innerHTML = 
                'Disconnected <span class="websocket-status websocket-disconnected"></span>';
            setTimeout(initWebSocket, 5000);
        };
        
        websocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            updatePriceDisplay(data);
        };
    }

    // Update price display
    function updatePriceDisplay(prices) {
        const container = document.getElementById('price-updates');
        const priceList = container.querySelector('div') || document.createElement('div');
        priceList.innerHTML = '';
        
        Object.entries(prices).forEach(([symbol, price]) => {
            const priceItem = document.createElement('div');
            priceItem.className = 'price-item';
            priceItem.innerHTML = `
                <span>${symbol}</span>
                <span>$${price.toFixed(2)}</span>
            `;
            priceList.appendChild(priceItem);
        });
        
        if (!container.querySelector('div')) {
            container.appendChild(priceList);
        }
    }

    // Save API key
    function saveApiKey() {
        const key = document.getElementById('alpha-vantage-key').value;
        if (key) {
            localStorage.setItem('alphaVantageKey', key);
            apiKey = key;
            alert('API key saved successfully');
        }
    }

    // Export trade history
    function exportTrades(format) {
        const data = tradeHistory.map(trade => ({
            timestamp: trade.timestamp,
            symbol: trade.symbol,
            type: trade.type,
            price: trade.price,
            quantity: trade.quantity,
            total: trade.price * trade.quantity
        }));

        let content, mimeType, filename;
        
        if (format === 'csv') {
            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(trade => Object.values(trade).join(','));
            content = [headers, ...rows].join('\n');
            mimeType = 'text/csv';
            filename = 'trades.csv';
        } else {
            content = JSON.stringify(data, null, 2);
            mimeType = 'application/json';
            filename = 'trades.json';
        }

        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Calculate risk level
    function calculateRiskLevel() {
        const positionSize = parseFloat(document.getElementById('max-position-size').value);
        const stopLoss = parseFloat(document.getElementById('stop-loss').value);
        const takeProfit = parseFloat(document.getElementById('take-profit').value);
        
        let riskLevel = 'medium';
        if (positionSize <= 10 && stopLoss <= 3 && takeProfit >= 15) {
            riskLevel = 'low';
        } else if (positionSize >= 30 || stopLoss >= 10 || takeProfit <= 5) {
            riskLevel = 'high';
        }
        
        const indicator = document.getElementById('risk-indicator');
        indicator.className = `risk-indicator risk-${riskLevel}`;
        document.getElementById('risk-level').textContent = `Risk Level: ${riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1)}`;
    }

    // Calculate strategy metrics
    function calculateStrategyMetrics() {
        if (tradeHistory.length === 0) return;
        
        const winningTrades = tradeHistory.filter(trade => trade.type === 'SELL' && trade.price > tradeHistory.find(t => t.symbol === trade.symbol && t.type === 'BUY')?.price).length;
        const totalTrades = tradeHistory.filter(trade => trade.type === 'SELL').length;
        const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100).toFixed(1) : 0;
        
        const returns = tradeHistory.filter(trade => trade.type === 'SELL').map(trade => {
            const buyTrade = tradeHistory.find(t => t.symbol === trade.symbol && t.type === 'BUY');
            return ((trade.price - buyTrade.price) / buyTrade.price * 100);
        });
        
        const avgReturn = returns.length > 0 ? (returns.reduce((a, b) => a + b, 0) / returns.length).toFixed(1) : 0;
        
        // Simplified Sharpe ratio calculation
        const riskFreeRate = 0.02; // 2% annual risk-free rate
        const stdDev = returns.length > 0 ? Math.sqrt(returns.reduce((a, b) => a + Math.pow(b - avgReturn, 2), 0) / returns.length) : 0;
        const sharpeRatio = stdDev > 0 ? ((avgReturn - riskFreeRate) / stdDev).toFixed(2) : 0;
        
        // Calculate maximum drawdown
        let maxDrawdown = 0;
        let peak = initialBudget;
        let current = initialBudget;
        
        tradeHistory.forEach(trade => {
            const tradeAmount = trade.price * trade.quantity;
            current += trade.type === 'BUY' ? -tradeAmount : tradeAmount;
            
            if (current > peak) {
                peak = current;
            }
            
            const drawdown = ((peak - current) / peak * 100);
            if (drawdown > maxDrawdown) {
                maxDrawdown = drawdown;
            }
        });
        
        document.getElementById('win-rate').textContent = `${winRate}%`;
        document.getElementById('avg-return').textContent = `${avgReturn}%`;
        document.getElementById('sharpe-ratio').textContent = sharpeRatio;
        document.getElementById('max-drawdown').textContent = `${maxDrawdown.toFixed(1)}%`;
    }

    // Event listeners
    document.getElementById('start-button').addEventListener('click', startTrading);
    document.getElementById('stop-button').addEventListener('click', stopTrading);
    document.getElementById('search-button').addEventListener('click', () => {
        const query = document.getElementById('symbol-search').value.trim();
        if (query) searchStocks(query);
    });
    document.getElementById('symbol-search').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const query = e.target.value.trim();
            if (query) searchStocks(query);
        }
    });
    document.getElementById('refresh-chart').addEventListener('click', refreshChart);
    document.getElementById('save-api-key').addEventListener('click', saveApiKey);
    document.getElementById('export-csv').addEventListener('click', () => exportTrades('csv'));
    document.getElementById('export-json').addEventListener('click', () => exportTrades('json'));
    document.getElementById('max-position-size').addEventListener('change', calculateRiskLevel);
    document.getElementById('stop-loss').addEventListener('change', calculateRiskLevel);
    document.getElementById('take-profit').addEventListener('change', calculateRiskLevel);

    // Initialize chart on page load
    document.addEventListener('DOMContentLoaded', () => {
        initPerformanceChart();
        initWebSocket();
        
        // Load saved API key
        if (apiKey) {
            document.getElementById('alpha-vantage-key').value = apiKey;
        }
        
        // Add new event listeners
        document.getElementById('save-api-key').addEventListener('click', saveApiKey);
        document.getElementById('export-csv').addEventListener('click', () => exportTrades('csv'));
        document.getElementById('export-json').addEventListener('click', () => exportTrades('json'));
        
        // Risk management event listeners
        document.getElementById('max-position-size').addEventListener('change', calculateRiskLevel);
        document.getElementById('stop-loss').addEventListener('change', calculateRiskLevel);
        document.getElementById('take-profit').addEventListener('change', calculateRiskLevel);
        
        // Initialize risk level
        calculateRiskLevel();
    });
</script>
{% endblock %} 