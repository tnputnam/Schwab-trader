{% extends "base.html" %}

{% block title %}Strategy Dashboard{% endblock %}

{% block content %}
<div class="container">
    <h1>Strategy Testing Dashboard</h1>
    
    <!-- Tesla Analysis Section -->
    <div class="section">
        <h2>Tesla Analysis</h2>
        <div class="analysis-container">
            <div class="form-group">
                <button onclick="runTeslaAnalysis()" class="btn-primary">Run Tesla Analysis</button>
            </div>
            <div id="tesla-chart" class="chart-container"></div>
            <div id="tesla-metrics" class="metrics-container"></div>
        </div>
    </div>
    
    <!-- Backtesting Section -->
    <div class="section">
        <h2>Backtesting</h2>
        <div class="backtest-form">
            <div class="form-group">
                <label for="symbols">Symbols (comma-separated):</label>
                <input type="text" id="symbols" placeholder="AAPL,MSFT,GOOGL" value="AAPL,MSFT,GOOGL">
            </div>
            <div class="form-group">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate">
            </div>
            <div class="form-group">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate">
            </div>
            <button onclick="runBacktest()" class="btn-primary">Run Backtest</button>
        </div>
        <div id="backtest-results" class="results-container">
            <table>
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Strategy</th>
                        <th>Initial Price</th>
                        <th>Final Price</th>
                        <th>Total Return</th>
                        <th>Sharpe Ratio</th>
                        <th>Max Drawdown</th>
                        <th>Number of Trades</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="results-body"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Paper Trading Section -->
    <div class="section">
        <h2>Paper Trading</h2>
        <div class="paper-trading-form">
            <div class="form-group">
                <label for="paper-symbols">Symbols (comma-separated):</label>
                <input type="text" id="paper-symbols" placeholder="AAPL,MSFT,GOOGL" value="AAPL,MSFT,GOOGL">
            </div>
            <div class="form-group">
                <label for="strategy">Strategy:</label>
                <select id="strategy">
                    <option value="moving_average_crossover">Moving Average Crossover</option>
                    <option value="rsi">RSI</option>
                    <option value="bollinger_bands">Bollinger Bands</option>
                    <option value="macd">MACD</option>
                    <option value="volume">Volume</option>
                </select>
            </div>
            <button onclick="startPaperTrading()" class="btn-primary">Start Paper Trading</button>
        </div>
        <div id="paper-trading-results" class="results-container"></div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .section {
        margin-bottom: 40px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    input[type="text"],
    input[type="date"],
    select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    button {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }
    
    button:hover {
        background-color: #45a049;
    }
    
    .btn-primary {
        background-color: #007bff;
    }
    
    .btn-primary:hover {
        background-color: #0056b3;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    th {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    
    .analysis-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .chart-container {
        height: 400px;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
    }
    
    .metrics-container {
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .results-container {
        margin-top: 20px;
        overflow-x: auto;
    }
    
    .error {
        color: #dc3545;
        font-weight: bold;
    }
    
    .success {
        color: #28a745;
    }
    
    .loading {
        color: #6c757d;
        font-style: italic;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Set default dates
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);
        
        document.getElementById('startDate').value = oneYearAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
    });

    function runTeslaAnalysis() {
        const chartContainer = document.getElementById('tesla-chart');
        const metricsContainer = document.getElementById('tesla-metrics');
        
        chartContainer.innerHTML = '<div class="loading">Loading Tesla analysis...</div>';
        metricsContainer.innerHTML = '';
        
        fetch('/dashboard/api/run_tesla_analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'error') {
                chartContainer.innerHTML = `<div class="error">Error: ${data.message}</div>`;
                return;
            }
            
            // Update metrics
            metricsContainer.innerHTML = `
                <h3>Analysis Results</h3>
                <p>Volume Ratio: ${data.metrics.volumeRatio.toFixed(2)}x average</p>
                <p>Price Change: ${data.metrics.priceChange.toFixed(2)}%</p>
                ${data.signal ? `<p class="alert alert-${data.signal.type}">Signal: ${data.signal.message}</p>` : ''}
            `;
            
            // Create chart
            const ctx = document.createElement('canvas');
            chartContainer.innerHTML = '';
            chartContainer.appendChild(ctx);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.chart.labels,
                    datasets: [{
                        label: 'Tesla Stock Price',
                        data: data.chart.prices,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        })
        .catch(error => {
            chartContainer.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        });
    }
    
    function runBacktest() {
        const symbols = document.getElementById('symbols').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!symbols || !startDate || !endDate) {
            alert('Please fill in all fields');
            return;
        }
        
        const resultsBody = document.getElementById('results-body');
        resultsBody.innerHTML = '<tr><td colspan="9" class="loading">Running backtest...</td></tr>';
        
        fetch('/dashboard/api/run_backtest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbols: symbols.split(',').map(s => s.trim()),
                startDate: startDate,
                endDate: endDate
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'error') {
                resultsBody.innerHTML = `<tr><td colspan="9" class="error">${data.message}</td></tr>`;
                return;
            }
            
            resultsBody.innerHTML = '';
            data.results.forEach(result => {
                const row = document.createElement('tr');
                if (result.error) {
                    row.innerHTML = `
                        <td>${result.symbol}</td>
                        <td colspan="7" class="error">${result.error}</td>
                        <td><span class="badge bg-danger">Failed</span></td>
                    `;
                } else {
                    const returnClass = result.totalReturn >= 0 ? 'success' : 'error';
                    row.innerHTML = `
                        <td>${result.symbol}</td>
                        <td>${result.strategy}</td>
                        <td>$${result.initialPrice.toFixed(2)}</td>
                        <td>$${result.finalPrice.toFixed(2)}</td>
                        <td class="${returnClass}">${(result.totalReturn * 100).toFixed(2)}%</td>
                        <td>${result.sharpeRatio.toFixed(2)}</td>
                        <td class="error">${(result.maxDrawdown * 100).toFixed(2)}%</td>
                        <td>${result.numTrades}</td>
                        <td><span class="badge bg-success">Success</span></td>
                    `;
                }
                resultsBody.appendChild(row);
            });
        })
        .catch(error => {
            resultsBody.innerHTML = `<tr><td colspan="9" class="error">Error: ${error.message}</td></tr>`;
        });
    }
    
    function startPaperTrading() {
        const symbols = document.getElementById('paper-symbols').value;
        const strategy = document.getElementById('strategy').value;
        
        if (!symbols) {
            alert('Please enter symbols');
            return;
        }
        
        const resultsDiv = document.getElementById('paper-trading-results');
        resultsDiv.innerHTML = '<div class="loading">Starting paper trading...</div>';
        
        fetch('/dashboard/api/paper_trade', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbols: symbols.split(',').map(s => s.trim()),
                strategy: strategy
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'error') {
                resultsDiv.innerHTML = `<div class="error">${data.message}</div>`;
                return;
            }
            
            let html = '<div class="paper-trading-results">';
            
            // Current positions
            if (data.positions && Object.keys(data.positions).length > 0) {
                html += `
                    <h3>Current Positions</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Quantity</th>
                                <th>Average Price</th>
                                <th>Current Value</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                Object.entries(data.positions).forEach(([symbol, position]) => {
                    html += `
                        <tr>
                            <td>${symbol}</td>
                            <td>${position.quantity}</td>
                            <td>$${position.average_price.toFixed(2)}</td>
                            <td>$${(position.quantity * position.average_price).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            // Recent trades
            if (data.trades && data.trades.length > 0) {
                html += `
                    <h3>Recent Trades</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Action</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Profit/Loss</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.trades.forEach(trade => {
                    const profitClass = trade.profit >= 0 ? 'success' : 'error';
                    html += `
                        <tr>
                            <td>${new Date(trade.date).toLocaleString()}</td>
                            <td>${trade.symbol}</td>
                            <td>${trade.action}</td>
                            <td>${trade.quantity}</td>
                            <td>$${trade.price.toFixed(2)}</td>
                            <td class="${profitClass}">${trade.profit ? `$${trade.profit.toFixed(2)}` : '-'}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        })
        .catch(error => {
            resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        });
    }
</script>
{% endblock %} 