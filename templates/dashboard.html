<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Schwab Trader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Schwab Trader</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/strategies">Strategies</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/trading">Live Trading</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Schwab Account Dashboard</h1>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Account Summary</h5>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <tr>
                                <th>Account Number:</th>
                                <td>{{ account.account_number }}</td>
                            </tr>
                            <tr>
                                <th>Account Type:</th>
                                <td>{{ account.account_type }}</td>
                            </tr>
                            <tr>
                                <th>Cash Balance:</th>
                                <td>${{ "%.2f"|format(account.cash_balance) }}</td>
                            </tr>
                            <tr>
                                <th>Cash Available for Trading:</th>
                                <td>${{ "%.2f"|format(account.cash_available) }}</td>
                            </tr>
                            <tr>
                                <th>Total Account Value:</th>
                                <td>${{ "%.2f"|format(account.total_value) }}</td>
                            </tr>
                            <tr>
                                <th>Long Market Value:</th>
                                <td>${{ "%.2f"|format(account.long_market_value) }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Positions</h5>
                    </div>
                    <div class="card-body">
                        {% if account.positions %}
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Quantity</th>
                                        <th>Avg Price</th>
                                        <th>Current Price</th>
                                        <th>Change</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody id="positionsTable">
                                    {% for position in account.positions %}
                                        <tr data-symbol="{{ position.symbol }}">
                                            <td>{{ position.symbol }}</td>
                                            <td>{{ position.quantity }}</td>
                                            <td>${{ "%.2f"|format(position.averagePrice) }}</td>
                                            <td class="current-price">Loading...</td>
                                            <td class="change">Loading...</td>
                                            <td class="value">Loading...</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>No positions found or positions data not available.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Market Data</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="marketData">
                            <!-- Market data will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Technical Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="technicalAnalysis">
                            <!-- Technical analysis charts will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Actions</h5>
                    </div>
                    <div class="card-body">
                        <a href="/test_strategies" class="btn btn-primary">Test Trading Strategies</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script>
        // Function to format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        }

        // Function to format percentage
        function formatPercent(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'percent',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value / 100);
        }

        // Function to format large numbers
        function formatLargeNumber(value) {
            if (value >= 1e12) return (value / 1e12).toFixed(2) + 'T';
            if (value >= 1e9) return (value / 1e9).toFixed(2) + 'B';
            if (value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
            if (value >= 1e3) return (value / 1e3).toFixed(2) + 'K';
            return value.toFixed(2);
        }

        // Function to create price chart
        function createPriceChart(symbol, chartData) {
            const ctx = document.createElement('canvas');
            ctx.id = `${symbol}-price-chart`;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.dates,
                    datasets: [
                        {
                            label: 'Price',
                            data: chartData.close,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'SMA 20',
                            data: chartData.sma_20,
                            borderColor: 'rgb(255, 99, 132)',
                            borderDash: [5, 5],
                            tension: 0.1
                        },
                        {
                            label: 'SMA 50',
                            data: chartData.sma_50,
                            borderColor: 'rgb(54, 162, 235)',
                            borderDash: [5, 5],
                            tension: 0.1
                        },
                        {
                            label: 'BB Upper',
                            data: chartData.bb_upper,
                            borderColor: 'rgba(75, 192, 192, 0.5)',
                            borderDash: [2, 2],
                            tension: 0.1
                        },
                        {
                            label: 'BB Lower',
                            data: chartData.bb_lower,
                            borderColor: 'rgba(75, 192, 192, 0.5)',
                            borderDash: [2, 2],
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `${symbol} Price Chart`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            return ctx;
        }

        // Function to create RSI chart
        function createRSIChart(symbol, chartData) {
            const ctx = document.createElement('canvas');
            ctx.id = `${symbol}-rsi-chart`;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.dates,
                    datasets: [{
                        label: 'RSI',
                        data: chartData.rsi,
                        borderColor: 'rgb(153, 102, 255)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `${symbol} RSI`
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
            
            return ctx;
        }

        // Function to update market data
        async function updateMarketData() {
            try {
                console.log('Fetching market data...');
                const marketDataUrl = '{{ account.market_data_url }}';
                console.log('Market data URL:', marketDataUrl);
                
                const response = await fetch(marketDataUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'  // Important for session cookies
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                
                const marketData = await response.json();
                console.log('Received market data:', marketData);
                
                if (Object.keys(marketData).length === 0) {
                    console.warn('No market data received');
                    return;
                }
                
                // Update positions table
                Object.entries(marketData).forEach(([symbol, data]) => {
                    console.log(`Processing data for ${symbol}:`, data);
                    const row = document.querySelector(`tr[data-symbol="${symbol}"]`);
                    if (row) {
                        const currentPriceCell = row.querySelector('.current-price');
                        const changeCell = row.querySelector('.change');
                        const valueCell = row.querySelector('.value');
                        
                        if (data.error) {
                            console.error(`Error for ${symbol}:`, data.error);
                            currentPriceCell.textContent = 'Error';
                            changeCell.textContent = 'Error';
                            valueCell.textContent = 'Error';
                        } else {
                            currentPriceCell.textContent = formatCurrency(data.current_price);
                            changeCell.textContent = `${formatCurrency(data.change)} (${formatPercent(data.change_percent)})`;
                            changeCell.className = `change ${data.change >= 0 ? 'text-success' : 'text-danger'}`;
                            
                            // Calculate position value
                            const quantity = parseFloat(row.querySelector('td:nth-child(2)').textContent);
                            const value = quantity * data.current_price;
                            valueCell.textContent = formatCurrency(value);
                        }
                    } else {
                        console.warn(`No row found for symbol ${symbol}`);
                    }
                });
                
                // Update market data cards
                const marketDataContainer = document.getElementById('marketData');
                if (!marketDataContainer) {
                    console.error('Market data container not found');
                    return;
                }
                
                marketDataContainer.innerHTML = Object.entries(marketData)
                    .map(([symbol, data]) => {
                        console.log(`Creating market data card for ${symbol}`);
                        return `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">${symbol}</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p class="card-text">
                                                    Price: ${formatCurrency(data.current_price)}<br>
                                                    Change: <span class="${data.change >= 0 ? 'text-success' : 'text-danger'}">
                                                        ${formatCurrency(data.change)} (${formatPercent(data.change_percent)})
                                                    </span><br>
                                                    Volume: ${data.volume.toLocaleString()}<br>
                                                    High: ${formatCurrency(data.high)}<br>
                                                    Low: ${formatCurrency(data.low)}
                                                </p>
                                            </div>
                                            <div class="col-md-6">
                                                <p class="card-text">
                                                    Bid: ${formatCurrency(data.bid)} (${data.bid_size})<br>
                                                    Ask: ${formatCurrency(data.ask)} (${data.ask_size})<br>
                                                    52W High: ${formatCurrency(data.fifty_two_week_high)}<br>
                                                    52W Low: ${formatCurrency(data.fifty_two_week_low)}<br>
                                                    P/E: ${data.pe_ratio.toFixed(2)}<br>
                                                    Market Cap: ${formatLargeNumber(data.market_cap)}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                
                // Update technical analysis charts
                const technicalAnalysisContainer = document.getElementById('technicalAnalysis');
                if (!technicalAnalysisContainer) {
                    console.error('Technical analysis container not found');
                    return;
                }
                
                technicalAnalysisContainer.innerHTML = Object.entries(marketData)
                    .map(([symbol, data]) => {
                        console.log(`Creating technical analysis charts for ${symbol}`);
                        return `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">${symbol} Technical Analysis</h5>
                                        <div class="row">
                                            <div class="col-12 mb-3">
                                                ${createPriceChart(symbol, data.chart_data).outerHTML}
                                            </div>
                                            <div class="col-12">
                                                ${createRSIChart(symbol, data.chart_data).outerHTML}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
            } catch (error) {
                console.error('Error updating market data:', error);
                // Show error message to user
                const marketDataContainer = document.getElementById('marketData');
                if (marketDataContainer) {
                    marketDataContainer.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger" role="alert">
                                Error fetching market data: ${error.message}
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Update market data every 5 seconds
        console.log('Starting market data updates...');
        updateMarketData();
        setInterval(updateMarketData, 5000);
    </script>
</body>
</html> 